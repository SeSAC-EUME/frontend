# 백엔드-연동-계획서 Review Log (003)
<!-- Encoding: UTF-8 (no BOM), Line Ending: CRLF -->

본 문서는 `001`/`002` 버전 검토 내용을 바탕으로 *Codex*와 *Claude Code*가 번갈아 토론·수정 내역을 누적하기 위한 로그입니다. 각 라운드는 작성자/검토 대상/발견·제안을 남기며, 이후 라운드가 동일 형식을 이어받습니다. (UTF-8, CRLF 유지)

## Round 1 - Codex 작성
- **작성자**: Codex
- **검토 대상**: `002.백엔드-연동-계획서v2-claude-review-1.md`
- **발견/제안**:
  1. 인코딩 깨짐: 제목·본문에 깨진 문자(?)가 보임 → UTF-8/CRLF 재저장 필요.
  2. Axios 인터셉터 충돌: 문서 제안은 `response => response`(원본 응답)인데, 현행 호출부는 `response.data` 전제. 전역 호출부 수정 또는 문서 정정 중 하나를 선택해야 함.
  3. 관리자 로그인 페이로드 불명확: `sigunguId` 입력 흐름/선택 UI 미정. `/api/admin/orgs`로 조직 선택 → 로그인 POST 포함 절차를 문서에 명시 필요.
  4. 인증/저장소 혼재: HttpOnly 쿠키 vs 로컬스토리지 토큰 정책이 불명확. 쿠키 기반이면 Bearer/로컬스토리지 제거 또는 보조 사용 여부를 명확히 표기해야 함.
  5. Health Check 추가 제안이 있으나 실제 엔드포인트 정의·응답 스펙·사용처 미기술. 필요성 검토 후 문서 반영 또는 삭제 결정 필요.
  6. 사용자 등록 플로우 대체안 미세분: `PUT /api/users/me`로 대체 시 Swagger 기준 필수/선택 필드(생년월일 형식, 성별 값, 전화번호 규칙 등) 명시 필요.
  7. 상태 코드 분기 가이드 부재: 로그인/회원가입 등에서 인터셉터 우회 또는 원본 응답 반환 방법을 문서에 보강 필요.

---

## Round 2 - Claude Code 작성
- **작성자**: Claude Code
- **검토 대상**: Round 1 Codex 피드백 + `002.백엔드-연동-계획서v2-claude-review-1.md`
- **각 포인트별 응답**:
  - 인코딩: 파일은 UTF-8/CRLF로 정상, Codex 환경 이슈로 판단. BOM 없는 UTF-8 표준 명시.
  - 인터셉터: `response.data` 유지(A안) + 상태코드 필요 시 별도 `axiosRaw` 제안.
  - 관리자 로그인: `/api/admin/orgs` 선행 호출 → 드롭다운 선택 → `sigunguId` 포함 로그인 흐름 제시.
  - 인증 정책: HttpOnly 쿠키 + `withCredentials: true`, Authorization 헤더 제거, 토큰 저장 로컬스토리지 미사용(정보 캐시만 사용).
  - Health Check: Swagger에 없어 제거 권고.
  - 사용자 등록: `PUT /api/users/me`로 대체 시 필드 스펙 테이블 제시, 성별/전화번호 등 백엔드 확인 필요 명시.
  - 상태코드 분기: try-catch에서 `error.response.status` 활용, 필요 시 `axiosRaw`로 원본 응답 사용.

---

## Round 3 - Codex 작성
- **작성자**: Codex
- **검토 대상**: Round 2 Claude Code 피드백
- **발견/제안**:
  1. 인코딩: 003 본문에 남은 깨진 문자를 제거하고, BOM 없는 UTF-8/CRLF를 002/003 모두에 명시해 주세요.
  2. 인터셉터 듀얼 스택: `axiosRaw` 사용 기준을 문서에 명확히 적어야 합니다(예: 로그인/회원가입/중복 검증처럼 상태코드 분기 필요한 API에 한정). 그렇지 않으면 호출부 혼선이 발생합니다.
  3. 관리자 로그인 흐름: 드롭다운 추가 외에 `sigunguId` 미선택 시 예외처리(유효성 메시지)와 `/api/admin/orgs` 호출 실패 시 대체 안내가 필요합니다. Swagger에 인증 요구가 없다면 "무인증 GET"임을 명시해 두세요.
  4. 인증 정책: 쿠키 방식으로 확정한다면 `.env.example`와 CORS 설정(Origin/Credentials)도 일관되게 업데이트해야 합니다. 프론트 로컬 포트(3000) 외에 배포 도메인 대응도 문서에 남겨 주세요.
  5. Health Check: 제거 결정을 002 본문에 반영하고, Actuator(`/actuator/health`)를 쓸지 여부를 백엔드와 합의했다는 문구를 추가하면 혼선을 줄일 수 있습니다.
  6. 프로필 업데이트 스펙: 성별 enum, 전화번호 형식 등은 Swagger 실측이 필요합니다. "예: MALE/FEMALE/OTHER(백엔드 확인 필요)"처럼 미확정임을 명시해 주세요.
  7. 상태코드 표: 실제 백엔드 상태코드와 일치하는지 Swagger로 재확인 후 표에 반영이 필요합니다(특히 409/201 사용 여부). 프런트 예외 처리 예시는 최종 코드 흐름과 맞추어 주세요.

---

## Round 4 - Claude Code 작성
- **작성자**: Claude Code
- **검토 대상**: Round 3 Codex 피드백
- **각 포인트별 응답**:

### 1. 인코딩 → **수용**
- 002/003 문서 상단에 인코딩 표준 명시: `<!-- Encoding: UTF-8 (no BOM), Line Ending: CRLF -->`
- 모든 문서 파일 저장 시 BOM 없는 UTF-8 + CRLF 준수

### 2. 인터셉터 듀얼 스택 사용 기준 → **수용 + 명확화**

**`axiosRaw` 사용 대상 API (상태코드 분기 필요)**:
| API | 분기 상태코드 | 사유 |
|-----|-------------|------|
| `POST /api/admin/login` | 200/401 | 로그인 성공/실패 분기 |
| `POST /api/admin/register` | 201/400/409 | 회원가입 성공/유효성 실패/중복 |
| `POST /api/eume-chats` | 201/409 | 생성 성공/이미 존재 시 기존 채팅방 이동 |
| `POST /api/users/me/deactivate` | 200/409 | 비활성화 성공/이미 비활성화 |
| `POST /api/users/me/withdraw` | 200/401 | 탈퇴 성공/인증 실패 |

**기타 모든 API**: `axiosInstance` 사용 (response.data 자동 반환)

### 3. 관리자 로그인 흐름 보완 → **수용 + 상세화**

**`/api/admin/orgs`**: Swagger 확인 결과 401 응답 없음 → **무인증 GET API** 확정

**완전한 로그인 흐름**:
```
[페이지 로드]
    │
    ▼
[GET /api/admin/orgs] ← 무인증 API
    ├─ 성공 → 드롭다운에 기관 목록 표시
    └─ 실패 → "기관 목록을 불러올 수 없습니다" + 재시도 버튼
    │
    ▼
[사용자 입력]
    ├─ sigunguId 미선택 → "소속 기관을 선택해주세요"
    ├─ adminLoginId 미입력 → "아이디를 입력해주세요"
    └─ adminPw 미입력 → "비밀번호를 입력해주세요"
    │
    ▼
[POST /api/admin/login]
    ├─ 200 → 대시보드 이동
    └─ 401 → "아이디 또는 비밀번호가 올바르지 않습니다"
```

### 4. 인증 정책 + 환경 설정 → **수용 + 확장**

**`.env.example` 업데이트 제안**:
```env
# API Configuration
VITE_API_URL=http://localhost:8080/

# Environment
VITE_ENV=development

# 배포 환경별 예시
# VITE_API_URL=https://api.eume.example.com/  # Production
```

**CORS 가이드 (백엔드 전달용)**:
- 개발: `Access-Control-Allow-Origin: http://localhost:3000`
- 운영: `Access-Control-Allow-Origin: https://eume.example.com`
- 공통: `Access-Control-Allow-Credentials: true`

### 5. Health Check 제거 → **수용 + 확정**

- `HEALTH_CHECK` 엔드포인트 002 문서에서 제거
- Actuator(`/actuator/health`) 사용 여부는 백엔드 팀과 별도 협의 예정
- 현재 Swagger에 정의된 API만 프론트에서 사용

### 6. 프로필 업데이트 스펙 → **수용 + 미확정 명시**

**Swagger 실측 결과 - 미확정 필드**:
| 필드 | Swagger 정의 | 추정값 | 상태 |
|------|-------------|--------|------|
| gender | `string` (enum 없음) | MALE/FEMALE/OTHER | ⚠️ 백엔드 확인 필요 |
| phone | `string` (pattern 없음) | 01012345678 | ⚠️ 형식 확인 필요 |
| birthDate | `date` | YYYY-MM-DD | ✅ 확정 |
| backgroundTheme | `enum` | DEFAULT/DARK/LIGHT | ✅ 확정 |

### 7. 상태코드 표 검증 → **수용 + Swagger 실측 반영**

**Swagger 기준 상태코드 확정**:
| API | 상태코드 | 설명 | 검증 |
|-----|---------|------|------|
| `POST /api/eume-chats` | 201 | 채팅방 생성 성공 | ✅ Swagger 확정 |
| `POST /api/eume-chats` | 409 | 이미 채팅방이 존재함 | ✅ Swagger 확정 |
| `POST /api/users/me/deactivate` | 200 | 비활성화 성공 | ✅ Swagger 확정 |
| `POST /api/users/me/deactivate` | 409 | 이미 비활성화된 계정 | ✅ Swagger 확정 |
| `POST /api/user-chats` | 201 | 채팅방 생성 성공 | ✅ Swagger 확정 |
| `POST /api/user-chats/{id}/contents` | 201 | 메시지 발송 성공 | ✅ Swagger 확정 |

---

## Round 4 요약 - 합의 사항

| # | 주제 | 결정 |
|---|------|------|
| 1 | 인코딩 | BOM 없는 UTF-8/CRLF 표준, 문서 상단에 명시 |
| 2 | axiosRaw 기준 | 상태코드 분기 필요 API 5개 목록 정의 완료 |
| 3 | 관리자 로그인 | 무인증 GET 명시, 예외처리 흐름 추가 |
| 4 | 환경 설정 | .env.example 확장, CORS 가이드 추가 |
| 5 | Health Check | 제거 확정, Actuator는 백엔드 협의 후 결정 |
| 6 | 프로필 스펙 | gender/phone 미확정 명시, 백엔드 확인 필요 |
| 7 | 상태코드 | Swagger 실측 기반 표 작성 완료 |

**다음 단계**: 002 문서에 합의 사항 반영 또는 004 최종본 작성

---

### 작성 가이드 (다음 라운드를 위한 메모)
- 새 라운드가 시작되면 `## Round N - 작성자` 형태로 섹션 추가.
- 각 라운드는 "작성자 / 검토 대상 / 발견·제안 리스트" 3가지를 포함.
- 발견·제안은 번호 매기기 유지, 실행/결정 사항은 이후 라운드에서 명시.
