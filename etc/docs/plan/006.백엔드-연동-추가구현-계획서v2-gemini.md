# 006. 백엔드 연동 추가 구현 계획서 (v2 - Gemini 종합본)

**작성자**: Gemini (Claude, Codex 계획서 종합)
**작성일**: 2025년 11월 28일

## 1. 현황 분석

현재 프론트엔드 프로젝트와 백엔드 API 명세(`src/shared/api/config.js`) 및 기존 계획서들을 종합 분석한 결과, 연동 현황은 다음과 같습니다.

### 1.1 API 엔드포인트 구현 현황

| 구분 | API 엔드포인트 | 구현 상태 | 관련 페이지/컴포넌트 | 비고 |
|---|---|---|---|---|
| **공통/사용자 기능** | | | | |
| | `USER.ME` (GET/PUT) | **구현 완료** | `OAuth2Redirect`, `Onboarding4`, `Settings` | 사용자 정보 조회 및 프로필/테마 수정 |
| | `USER.LOGOUT` (POST) | **구현 완료** | `Settings`, `Sidebar` | |
| | `USER.WITHDRAW` (POST) | **미구현** | `Settings` | 회원 탈퇴 기능 필요 |
| | `USER.DEACTIVATE` (POST) | **미구현** | `Settings` | 계정 비활성화 기능 필요 |
| | | | | |
| **Eume AI 채팅 기능** | | | | |
| | `EUME_CHAT.CREATE` (POST) | **구현 완료** | `Home` | 채팅방 자동 생성 (초기 진입 시) |
| | `EUME_CHAT.ME` (GET) | **구현 완료** | `Home` | 채팅방 ID 조회 |
| | `EUME_CHAT.CONTENTS` (POST) | **구현 완료** | `Home` | AI에게 메시지 전송 |
| | `EUME_CHAT.CONTENTS` (GET) | **부분 구현 (히스토리 로딩 미구현)** | `Home` | 과거 대화 내역 조회 (API는 정의, 프론트엔드 미연동) |
| | | | | |
| **사용자 일반 채팅 기능 (UserChat)** | | | | **전체 미구현** |
| | `USER_CHAT.LIST` (GET) | **미구현** | `Home` (사이드바) | 사용자 참여 채팅방 목록 조회 |
| | `USER_CHAT.CREATE` (POST) | **미구현** | `Home` (사이드바) | 새 일반 채팅방 생성 |
| | `USER_CHAT.CONTENTS` (GET/POST) | **미구현** | `Home` | 일반 채팅 메시지 송수신 |
| | | | | |
| **관리자 기능** | | | | |
| | `ADMIN.LOGIN` (POST) | **구현 완료** | `Login` | |
| | `ADMIN.REGISTER` (POST) | **구현 완료** | `Login` | |
| | `ADMIN.LOGOUT` (POST) | **구현 완료** | `AdminLayout` | |
| | `ADMIN.ORGS` (GET) | **구현 완료** | `Login` | 복지기관 목록 조회 (무인증 API) |
| | `ADMIN.USERS` (GET) | **구현 완료** | `Users` | 전체 이용자 목록 조회 |
| | `ADMIN.USERS_EXPORT` (GET) | **구현 완료** | `Users` | 이용자 목록 Excel 내보내기 |
| | `ADMIN.REPORTS_SUMMARY` (GET) | **구현 완료** | `Dashboard` | 대시보드 통계 요약 정보 |
| | `ADMIN.REPORTS_EXPORT` (GET) | **구현 완료** | `Dashboard` | 전체 보고서 Excel 다운로드 |
| | `ADMIN.USER_DETAIL` (GET) | **미구현** | `Users` (상세) | 특정 이용자 상세 정보 조회 |
| | `ADMIN.USER_STATUS` (PUT/PATCH) | **미구현** | `Users` (상세) | 이용자 상태 (활성/비활성) 변경 |
| | `ADMIN.USER_EMOTIONS` (GET) | **미구현** | `EmotionMonitor` | 특정 이용자 감정 데이터 조회 |
| | `ADMIN` (대화 분석) | **API 명세 불분명 / 프론트 미구현** | `Conversation` | 백엔드 API 정의 및 프론트 구현 필요 |
| | `ADMIN` (보고서) | **API 명세 불분명 / 프론트 미구현** | `Reports` | 백엔드 API 정의 및 프론트 구현 필요 |

---

### 1.2 페이지별 Mock 데이터 사용 현황

| 페이지 | 파일 | 현재 API 연동 상태 | Mock 데이터 사용 여부 |
|---|---|---|---|
| **사용자 페이지** | | | |
| 홈 (채팅) | `Home.jsx` | `EUME_CHAT` 부분 연동 | `UserChat` 관련 Mock 데이터 사용 (Pinned Rooms) |
| 설정 | `Settings.jsx` | `USER` 연동 완료 | - |
| **관리자 페이지** | | | |
| 대시보드 | `Dashboard.jsx` | `ADMIN.REPORTS` 연동 완료 | - |
| 이용자 관리 | `Users.jsx` | `ADMIN.USERS` 연동 완료 | - |
| 감정 모니터링 | `EmotionMonitor.jsx` | **전체 미연동** | ✅ 전체 Mock 데이터 사용 |
| 대화 분석 | `Conversation.jsx` | **전체 미연동** | ✅ 전체 Mock 데이터 사용 |
| 정서 위험 감지 기록 | `Emergency.jsx` | **전체 미연동** | ✅ 전체 Mock 데이터 사용 |
| 보고서 | `Reports.jsx` | **전체 미연동** | ✅ 전체 Mock 데이터 사용 |

## 2. 추가 구현 계획

현황 분석 및 Claude, Codex 계획서를 종합하여 다음 우선순위에 따라 구현 계획을 수립합니다.

### **1순위: 핵심 사용자 경험 완성 및 관리자 주요 기능 보완**

#### 1.1. Eume AI 채팅 - 과거 대화 내역 로딩 (⭐ 최우선)
- **목표**: `Home` 페이지 진입 시, 기존 AI 채팅 내역을 불러와 표시하여 사용자가 이어서 대화할 수 있도록 한다.
- **세부 계획**:
    1. **(`Home.jsx`)** `loadExistingChat` 함수 수정: `EUME_CHAT.ME`로 `chatListId`를 받은 후, `EUME_CHAT.CONTENTS(chatListId)`에 `GET` 요청을 보내 과거 메시지 목록을 가져온다.
    2. API 응답으로 받은 메시지 목록을 `messagesByRoom` 상태의 초기값으로 설정한다.
    3. 데이터 로딩 중 사용자에게 로딩 스피너 등의 시각적 피드백을 제공한다.
    4. **(개선)** `chatListId`는 페이지 로드 시 한 번만 가져와 상태로 관리하여, 메시지 전송 시 불필요한 중복 API 호출을 방지한다.

#### 1.2. 관리자 - 이용자 상세 정보 및 감정 데이터 조회
- **목표**: `Users` 페이지에서 특정 이용자를 선택(클릭)하면, 해당 이용자의 상세 정보와 감정 데이터를 확인할 수 있는 모달 또는 전용 페이지를 제공한다.
- **세부 계획**:
    1. **(`Users.jsx`)** 이용자 목록 테이블의 각 행에 클릭 이벤트를 추가하여 `userId`를 인자로 전달하는 핸들러를 구현한다.
    2. **(`Users.jsx`)** 이용자 상세 정보 및 감정 데이터를 표시할 모달 컴포넌트를 생성하거나, `/admin/users/:userId`와 같은 상세 페이지 라우트를 구현한다.
    3. `ADMIN.USER_DETAIL(userId)` API를 호출하여 이용자 기본 정보(이름, 이메일, 가입일 등)를 가져온다.
    4. `ADMIN.USER_EMOTIONS(userId)` API를 호출하여 해당 이용자의 감정 변화 추이, 감정 분포 등의 데이터를 가져온다.
    5. 가져온 정보들을 모달/상세 페이지에 효과적으로 시각화하여 표시한다. (예: 감정 변화 그래프, 주요 대화 주제 등)

---

### **2순위: 신규 핵심 기능 구현 및 관리자 대시보드 확장**

#### 2.1. 사용자 - 일반 채팅 (UserChat) 기능 구현 (⭐ 중요)
- **목표**: 사용자가 AI가 아닌 다른 관리자/상담사와 1:1 대화를 나눌 수 있는 기능을 제공한다.
- **세부 계획**:
    1. **(UI/UX 기획)** `Home` 페이지 사이드바에 AI 채팅과 일반 채팅을 명확히 구분하는 UI 요소(탭, 버튼, 목록)를 디자인한다.
    2. **(API)** 페이지/컴포넌트 로드 시 `USER_CHAT.LIST` API를 호출하여 사용자가 참여 중인 일반 채팅방 목록을 가져온다.
    3. **(State)** 가져온 채팅방 목록과 개별 채팅방의 `chatListId`를 상태로 관리하고 사이드바에 렌더링한다.
    4. **(UI/API)** 사이드바에서 특정 일반 채팅방 클릭 시, `USER_CHAT.CONTENTS(chatListId)`에 `GET` 요청을 보내 해당 채팅방의 메시지 내역을 불러온다. 메시지 전송 시에는 `USER_CHAT.CONTENTS(chatListId)`에 `POST` 요청을 보낸다.
    5. `EumeChat`과 `UserChat` 메시지 상태를 분리하거나, 기존 `messagesByRoom` 상태 구조를 `roomId` 기반으로 확장하여 통합 관리하는 전략을 수립한다.
    6. **(Optional)** 실시간 채팅을 위해 WebSocket 또는 SSE 도입을 검토한다.

#### 2.2. 관리자 - 감정 모니터링 페이지 동적 데이터 연동
- **목표**: `EmotionMonitor.jsx`의 정적 데이터를 실제 API 데이터로 교체하여 관리자가 실시간에 가까운 감정 데이터를 확인할 수 있도록 한다.
- **세부 계획**:
    1. **(백엔드 협의)** 전체 이용자 감정 통계 집계 및 기간별 감정 분포 데이터를 제공하는 API(`REPORTS_SUMMARY`와 유사한 `EMOTIONS_SUMMARY` 또는 `ADMIN.USER_EMOTIONS` 확장)가 필요한지 백엔드와 논의한다.
    2. **(API)** 페이지 로드 시 필요한 통계 API를 호출하고, 필터(기간, 감정 유형) 변경 시 데이터를 다시 가져온다.
    3. **(UI)** API 응답 데이터를 기반으로 감정 통계 카드, 감정 분포 차트, 이용자별 감정 현황 테이블을 동적으로 렌더링하도록 코드를 수정한다.
    4. **(UX)** 데이터 로딩 상태 및 에러 발생 시 사용자에게 명확한 피드백을 제공한다.

---

### **3순위: 사용자 편의 기능 및 API 명세 불분명 페이지 처리**

#### 3.1. 사용자 - 계정 관리 기능 (회원 탈퇴/비활성화)
- **목표**: `Settings` 페이지에 사용자가 스스로 계정을 관리할 수 있는 회원 탈퇴 및 계정 비활성화 기능을 추가한다.
- **세부 계획**:
    1. **(UI)** `Settings` 페이지 하단에 '계정 비활성화'와 '회원 탈퇴' 버튼을 추가하고, 클릭 시 사용자 재확인 모달을 표시한다.
    2. **(API)** '비활성화' 확인 시 `USER.DEACTIVATE` API를, '탈퇴' 확인 시 `USER.WITHDRAW` API를 호출한다.
    3. API 호출 성공 시, `localStorage`의 모든 사용자 관련 정보를 정리하고 로그인 페이지로 리다이렉트한다.

#### 3.2. 관리자 - 대화 분석 페이지 기획 및 구현
- **목표**: `Conversation.jsx`의 Mock 데이터를 실제 API와 연동하여 이용자 대화를 상세 분석할 수 있는 기능을 제공한다.
- **세부 계획**:
    1. **(기획/백엔드 협의)**
        - 모든 이용자의 대화를 검색하고 필터링하는 기능이 필요한지, 아니면 특정 이용자의 대화 내역을 상세 분석하는 기능인지 명확히 한다.
        - 대화 목록 조회, 특정 대화 상세 내용, 대화 감정 분석, 키워드 추출 등 필요한 API 명세를 백엔드와 정의한다. (예: `GET /api/admin/conversations?userId=&period=&...`)
    2. **(프론트엔드 구현)** 확정된 기획과 API 명세에 따라 `Conversation.jsx` 컴포넌트의 UI를 동적 데이터로 연동한다.

#### 3.3. 관리자 - 보고서 페이지 기획 및 구현
- **목표**: `Reports.jsx`의 Mock 데이터를 실제 API와 연동하여 다양한 유형의 보고서를 관리하고 생성할 수 있는 기능을 제공한다.
- **세부 계획**:
    1. **(기획/백엔드 협의)**
        - 정기적인 리포트를 시스템이 자동 생성하는지, 관리자가 직접 기간과 종류를 설정하여 생성하는지 정의한다.
        - 보고서 목록 조회, 특정 보고서 상세 보기, 새 보고서 생성, 보고서 다운로드에 필요한 API 명세를 백엔드와 정의한다. (예: `GET /api/admin/reports`, `POST /api/admin/reports/generate`)
    2. **(프론트엔드 구현)** 확정된 기획과 API 명세에 따라 `Reports.jsx` 컴포넌트의 UI를 동적 데이터로 연동한다.

---

### **공통 개선 사항 (모든 페이지 및 컴포넌트에 적용 고려)**

1.  **라우터 보호 및 접근 제어 강화**: `AdminLayout` 외에 사용자 페이지(`UserHome`, `UserSettings`) 등에도 로그인 여부를 확인하는 라우터 가드 또는 훅을 적용하여 미인증 사용자 접근을 방지한다.
2.  **사용자 피드백 개선**: API 호출 성공/실패 시 `Toast Message` (팝업 알림) 등을 통해 사용자에게 더 명확하고 부드러운 피드백을 제공한다. (현재 `alert` 위주)
3.  **데이터 패칭 라이브러리 도입 검토**: `SWR` 또는 `React Query`와 같은 라이브러리를 도입하여 데이터 캐싱, 재검증, 자동 재시도 등 비동기 데이터 관리의 효율성과 견고성을 높이는 것을 검토한다.
4.  **실시간 기능 구현 고려**: 사용자 일반 채팅(UserChat), 관리자 긴급 상황 모니터링 등 실시간 업데이트가 필요한 기능에 대해 WebSocket 또는 SSE(Server-Sent Events) 도입을 백엔드와 협의하여 검토한다. (현재 Mock 상태인 `Emergency.jsx` 포함)

---

## 3. 백엔드 API 확인 필요 사항

프론트엔드 구현을 위해 백엔드 API 명세에 대한 추가 확인 및 정의가 필요한 항목들입니다.

### 3.1 신규 API 정의 및 존재 여부 확인
1.  **사용자 일반 채팅 (UserChat) 관련**:
    *   사용자 참여 채팅방 목록 조회 API
    *   새 일반 채팅방 생성 API
    *   일반 채팅 메시지 송수신 API (AI 채팅과 분리 또는 통합 방식 확인)
2.  **관리자 - 감정 모니터링 관련**:
    *   특정 기간 동안의 전체 이용자 감정 통계 집계 API (예: `EMOTIONS_SUMMARY`)
    *   이용자별 최근 감정 상태를 `ADMIN.USERS` 응답에 포함하거나 별도의 API 정의
3.  **관리자 - 대화 분석 관련**:
    *   관리자용 대화 목록 조회 및 필터링 API (이용자 ID, 기간, 감정 등)
    *   특정 대화 상세 내용 조회 API
    *   대화 감정 분석 및 키워드 추출 결과 API
    *   대화 통계 집계 API
4.  **관리자 - 보고서 관련**:
    *   보고서 목록 조회 API
    *   새 보고서 생성 API (기간, 종류 등 파라미터)

### 3.2 응답 형식 및 파라미터 확인 필요
1.  `GET /api/admin/users/{id}/emotions`: 감정 데이터의 상세 형식 (시간별 추이, 분포 등)
2.  `PUT /api/admin/users/{id}/status`: 요청 바디 및 응답 형식, 상태 변경 사유 필드 포함 여부
3.  `GET /api/user-chats`: 채팅방 목록의 상세 형식 (채팅방 ID, 이름, 마지막 메시지, 참여자 정보 등)
4.  `GET /api/user-chats/{id}/contents`: 대화 내용의 상세 형식 (메시지 ID, 발신자, 내용, 시간, 감정 분석 결과 등)

---

## 4. 구현 순서 제안 (단계별 접근)

### Phase 1: 핵심 사용자 경험 안정화 및 관리자 기본 모니터링 (1-2주)
1.  **1순위** Eume AI 채팅 - 과거 대화 내역 로딩 (`Home.jsx`)
2.  **1순위** 관리자 - 이용자 상세 정보 및 감정 데이터 조회 (`Users.jsx`, `EmotionMonitor.jsx` 연동 포함)
3.  **3순위** 사용자 - 계정 관리 기능 (회원 탈퇴/비활성화) (`Settings.jsx`)

### Phase 2: 신규 핵심 채팅 기능 및 관리자 상세 모니터링 (2-3주)
1.  **2순위** 사용자 - 일반 채팅 (UserChat) 기능 구현 (`Home.jsx`, `Sidebar.jsx`)
2.  **2순위** 관리자 - 감정 모니터링 페이지 동적 데이터 연동 (`EmotionMonitor.jsx`)

### Phase 3: 관리자 분석 및 편의 기능 (3-4주)
1.  **3순위** 관리자 - 대화 분석 페이지 기획 및 구현 (`Conversation.jsx`)
2.  **3순위** 관리자 - 보고서 페이지 기획 및 구현 (`Reports.jsx`)
3.  **공통 개선** 라우터 보호 및 접근 제어 강화 (사용자 페이지)
4.  **공통 개선** 사용자 피드백 개선 (Toast 메시지)

### Phase 4: 기술적 고도화 및 마무리 (4주차 이후)
1.  **공통 개선** 데이터 패칭 라이브러리 도입 검토 (SWR/React Query)
2.  **공통 개선** 실시간 기능 구현 고려 (WebSocket/SSE)

---

## 5. 기술적 고려사항

### 5.1 인증 방식
- 현재: HttpOnly 쿠키 기반 인증 (`withCredentials: true`)
- `axios` 인터셉터를 통한 `401 Unauthorized` 에러 시 로그인 페이지 리다이렉트 처리 완료
- 로그인 페이지에서 유효한 세션 존재 시 대시보드/홈으로 자동 리다이렉트 처리 완료

### 5.2 상태 관리
- 현재는 React 컴포넌트의 로컬 상태(`useState`, `useReducer`)와 `localStorage`를 주로 활용.
- `Context API`를 활용한 전역 상태 관리 (예: 사용자 인증 정보, 테마)는 이미 일부 적용 중.
- 복잡한 비동기 데이터 관리 및 전역 상태 공유가 필요한 경우 `React Query` 또는 `SWR`과 같은 라이브러리 도입을 적극 검토하여 캐싱, 재요청, 오류 처리 등을 효율적으로 관리.

### 5.3 실시간 기능
- `UserChat`, `Emergency` 페이지의 실시간 데이터 업데이트 구현 시 백엔드 지원 여부 및 트래픽 양에 따라 `WebSocket` (양방향 실시간 통신), `SSE` (단방향 서버-클라이언트 실시간 통신), 또는 `Polling` (주기적 API 호출) 중 적합한 방식을 백엔드와 협의하여 결정.

### 5.4 에러 처리 및 사용자 경험
- API 에러 발생 시 `alert` 대신 `Toast Message`와 같은 비침해적인 UI 요소로 사용자에게 명확하고 친화적인 메시지 전달.
- 네트워크 오프라인 상태 감지 및 사용자 알림, 재연결 시 데이터 동기화, API 요청 재시도 로직 등을 `axios` 인터셉터 또는 전역 에러 핸들링 컴포넌트에 구현하여 애플리케이션의 견고성 증대.

### 5.5 코드 품질 및 유지보수성
- 기존에 지적된 주석 인코딩 문제는 개발 표준으로 `UTF-8`을 강제하여 해결하고, 모든 개발자는 이를 준수하도록 한다.
- 커밋 메시지 규칙을 명확히 하고, 하나의 커밋이 여러 기능을 동시에 변경하는 것을 지양하여 코드 리뷰 및 히스토리 관리를 용이하게 한다.

---

## 6. 참고 파일 및 디렉토리

### API 관련
- `src/shared/api/config.js` - 모든 API 엔드포인트 정의
- `src/shared/api/axios.js` - 인증 처리용 Axios 인스턴스 및 인터셉터
- `src/shared/api/axiosRaw.js` - 순수 API 호출용 Axios 인스턴스 (인터셉터 최소화)
- `src/shared/constants/storage.js` - `localStorage` 키 상수 정의

### 사용자 페이지 및 컴포넌트
- `src/user/routes.jsx` - 사용자 라우트 정의
- `src/user/pages/Home.jsx` - 사용자 홈/채팅 메인 페이지
- `src/user/components/Sidebar.jsx` - 사용자 사이드바 (채팅방 목록 포함)
- `src/user/pages/Settings.jsx` - 사용자 설정 페이지

### 관리자 페이지 및 컴포넌트
- `src/admin/routes.jsx` - 관리자 라우트 정의
- `src/admin/components/AdminLayout.jsx` - 관리자 레이아웃 (인증 로직 포함)
- `src/admin/pages/Login.jsx` - 관리자 로그인/회원가입 페이지
- `src/admin/pages/Dashboard.jsx` - 관리자 대시보드
- `src/admin/pages/Users.jsx` - 관리자 이용자 관리 페이지
- `src/admin/pages/Conversation.jsx` - 관리자 대화 분석 페이지 (Mock)
- `src/admin/pages/Emergency.jsx` - 관리자 정서 위험 감지 기록 페이지 (Mock)
- `src/admin/pages/EmotionMonitor.jsx` - 관리자 감정 모니터링 페이지 (Mock)
- `src/admin/pages/Reports.jsx` - 관리자 보고서 페이지 (Mock)

---

## 7. 변경 이력

| 날짜 | 버전 | 작성자 | 내용 |
|------|------|--------|------|
| 2025-11-28 | 1.0 | Claude | 초안 작성 |
| 2025-11-28 | 1.1 | Codex | 기능별 상세 계획 추가 |
| 2025-11-28 | 1.2 | Gemini | 초기 분석 및 계획 |
| 2025-11-28 | 2.0 | Gemini | Claude, Codex, Gemini 계획 종합 및 재구성 |
