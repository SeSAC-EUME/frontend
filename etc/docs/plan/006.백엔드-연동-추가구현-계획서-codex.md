# 006. 백엔드 연동 추가구현 계획서 (Codex)
<!-- Encoding: UTF-8 (no BOM), Line Ending: CRLF -->

> **문서 버전**: 006
> **작성일자**: 2025-11-28
> **작성자**: Codex
> **목적**: Swagger(EumeChat/UserChat 등) 대비 프론트 미구현·미완성 기능을 정리하고, 단계별 구현 계획을 수립한다.

---

## 1. 현재 연동 상태 요약
- 공통: 쿠키 기반 인증 전환 완료(`axiosInstance` withCredentials), STORAGE_KEYS 도입. Blob 응답은 인터셉터로 `response.data`만 반환하는 상태.
- 사용자 영역
  - 로그인/OAuth/온보딩: OAuth2Redirect → GET `/api/users/me`, 온보딩4에서 PUT `/api/users/me`로 테마·닉네임 저장. 개인정보(이메일/생년/성별/전화)는 백엔드로 미전달.
  - 홈(Home.jsx): EumeChat 생성(POST `/api/eume-chats`) 및 전송(POST `/api/eume-chats/{id}/contents`) 일부 구현. 기존 채팅 내역 로드 UI 반영 없음. UserChat API 미사용.
  - 설정(Settings.jsx): 로그아웃(POST `/api/users/logout`), 테마 동기화(PUT `/api/users/me`) 구현. 탈퇴/휴면 API 미사용.
- 관리자 영역
  - 인증: 로그인/회원가입/로그아웃 API 연동 완료. 세션 검증은 AdminLayout에서 처리.
  - 대시보드: GET `/api/admin/reports/summary`, 보고서 다운로드(Blob) 호출 추가. 인터셉터로 MIME 정보 손실 가능.
  - 이용자 관리: GET `/api/admin/users`, GET `/api/admin/users/{id}` 사용. 상태 변경/감정 API 미사용. Excel 내보내기(Blob) 호출 추가.
  - 대화/감정/긴급/보고서 페이지: 현재 목업 데이터로 렌더링, 별도 API 연동 없음.

---

## 2. 미구현·보완 필요 항목
- **EumeChat(1:1 AI)**: 채팅방 ID 저장/재사용, 기존 대화 이력 로딩/렌더링, 전송 실패/재시도 UX, 201/409 분기 캐시 미흡.
- **UserChat(다중 채팅)**: Swagger 상 존재하지만 UI·상태·API 연동 전무. 채팅방 목록/생성/대화 조회/전송/삭제 흐름 설계 필요.
- **사용자 계정 플로우**: 탈퇴(DELETE/PUT `/api/users/me/withdraw`), 휴면(POST `/api/users/me/deactivate`) 미노출. 온보딩3 수집 정보(이메일/이름/생년/성별/전화) 백엔드 미전달.
- **파일 다운로드 응답 처리**: `axiosInstance` 인터셉터가 Blob의 Content-Type을 보존하지 않아 다운로드한 XLSX 인식 실패 가능.
- **관리자 이용자 상세 액션**: `/api/admin/users/{id}/status`, `/emotions` 등 상태 변경·감정 조회·일괄 작업 미구현. 상세 모달은 폴백 데이터만 사용.
- **관리자 기타 페이지**: EmotionMonitor/Conversation/Emergency/Reports 등은 목업 데이터. 실제 API 사양 확인 후 연동 필요 여부 판단.

---

## 3. 구현 계획 (우선순위별)
### 3.1 채팅 도메인
1) **EumeChat 보완**
   - 채팅방 생성(201) 및 존재(409) 시 `chatListId` 로컬 상태/스토리지에 저장 후 재사용.
   - GET `/api/eume-chats/me` → 메시지 목록/메타를 UI에 반영, 페이징/무한스크롤 설계.
   - POST `/api/eume-chats/{id}/contents` 응답을 메시지 스트림에 반영, 실패 시 재시도 버튼/에러 메시지 표준화.
2) **UserChat 신규 연동**
   - GET `/api/user-chats` → 좌측 히스토리/핀 목록 대체, 최근순 정렬/검색/필터.
   - POST `/api/user-chats` → “새 채팅” 생성 후 해당 채팅방으로 이동.
   - GET `/api/user-chats/{chatListId}/contents` → 메시지 목록 렌더링.
   - POST `/api/user-chats/{chatListId}/contents` → 메시지 전송. 필요 시 삭제/종료 API 확인.

### 3.2 사용자 계정/온보딩
- 온보딩4 PUT `/api/users/me`에 온보딩3 수집 필드(email/userName/birthDate/gender/phone/providerId 등) 포함, 백엔드 스키마 매핑.
- 설정/계정 메뉴에 **탈퇴/휴면** 액션 추가: WITHDRAW/DEACTIVATE API 호출, 성공 시 로컬 스토리지 정리 및 로그인 페이지 리다이렉트.
- Splash/Settings/Sidebar/Onboarding 흐름에서 STORAGE_KEYS 정리 누락 방지(임시 OAuth 키 포함).

### 3.3 관리자 기능
- 이용자 상세 모달: GET `/api/admin/users/{id}` 결과 매핑, 상태 변경 PATCH(`/status`), 감정 이력 GET(`/emotions`) 노출. 실패 시 안내 메시지.
- 일괄 작업/엑셀 내보내기: 실패 알림 및 재시도 UX 추가. Blob 다운로드 시 MIME 지정 또는 인터셉터 우회 인스턴스 사용.
- 대시보드 보고서 다운로드: Blob 처리 개선(axiosRaw 또는 타입 지정), 로딩 상태/에러 알림 명확화.
- 기타 페이지(Conversation/EmotionMonitor/Emergency/Reports): Swagger 스펙 확인 후 API 연결 필요 여부 결정. 미제공 시 목업임을 명시.

### 3.4 공통 기술 부채
- **Blob 응답 전용 axios 인스턴스**: `responseType: 'blob'` 요청 시 인터셉터를 우회하여 Content-Type 보존.
- **에러 처리 일관성**: 401 → 로그인 리다이렉트, 4xx 사용자 메시지, 5xx 재시도 가이드 등 공통 훅/유틸 도입.
- **상태/키 관리**: chatListId, onboarding 임시 데이터 등 STORAGE_KEYS 통일 및 정리.

---

## 4. 작업 순서 제안
1) 공통/기술 부채 정리: Blob 인스턴스, 에러 핸들러, STORAGE_KEYS 클린업.
2) 사용자 채팅 도메인: EumeChat 보완 → UserChat 신규 연동 → UX 검증.
3) 사용자 계정 플로우: 온보딩 데이터 전달 보완, 탈퇴/휴면 버튼 및 플로우 추가.
4) 관리자: 이용자 상세/상태/감정 연동 → 다운로드 처리 개선 → 기타 페이지 API 필요성 점검/연동.

---

## 5. 검증/체크리스트
- 채팅: 신규/기존 채팅방 모두 정상 로드, 메시지 송수신/재시도, 채팅방 전환 시 상태 유지.
- 계정: 온보딩 완료 후 백엔드 프로필 필드 반영, 탈퇴/휴면 시 세션·스토리지 정리 및 재로그인 요구.
- 다운로드: 보고서/Excel 파일이 정상 열림(파일 크기·MIME 확인), 실패 시 사용자 피드백.
- 관리자: 이용자 상세 데이터와 상태 변경이 백엔드와 일치, 감정 이력 노출.
