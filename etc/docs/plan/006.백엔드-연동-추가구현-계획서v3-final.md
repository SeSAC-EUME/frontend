# 006. 백엔드 연동 추가 구현 계획서 v3 (Final)

> **문서 버전**: 006-v3-final
> **작성일자**: 2025-11-28
> **작성자**: Claude (Claude/Codex/Gemini v1+v2 총 6개 문서 종합)
> **목적**: Swagger API 명세 대비 프론트엔드 미구현/미완성 기능을 최종 정리하고, 실행 가능한 구현 로드맵을 확정한다.

---

## 1. Executive Summary

### 1.1 핵심 발견 사항
| 영역 | 완료 | 부분 구현 | 미구현 |
|------|------|----------|--------|
| 사용자 인증/계정 | 4개 | 0개 | 0개 |
| AI 채팅 (EUME_CHAT) | 3개 | 1개 | 0개 |
| 일반 채팅 (USER_CHAT) | 0개 | 0개 | **4개** |
| 관리자 기본 | 8개 | 0개 | 2개 |
| 관리자 분석 페이지 | 0개 | 0개 | **4개 (Mock)** |

### 1.2 최우선 과제 (3개 AI 공통 합의)
1. **EUME_CHAT 과거 대화 로딩** - 새로고침 시 대화 유실 문제
2. **USER_CHAT 전체 구현** - 다중 채팅방 기능 전무
3. **Blob 응답 처리 개선** - Excel/PDF 다운로드 오류 가능성

---

## 2. 상세 현황 분석

### 2.1 API 구현 현황 매트릭스

#### 사용자 API (USER) - 완료율 100%
| API | HTTP | 상태 | 파일 | 검증 필요 |
|-----|------|------|------|----------|
| `/api/users/me` | GET | ✅ | Login, Settings, OAuth2Redirect | - |
| `/api/users/me` | PUT | ✅ | Onboarding4, Settings | 온보딩3 필드 전달 여부 |
| `/api/users/logout` | POST | ✅ | Sidebar, Settings | - |
| `/api/users/me/withdraw` | DELETE | ✅ | Settings (005 구현) | - |
| `/api/users/me/deactivate` | PUT | ✅ | Settings (005 구현) | - |

#### AI 채팅 API (EUME_CHAT) - 완료율 75%
| API | HTTP | 상태 | 파일 | 문제점 |
|-----|------|------|------|--------|
| `/api/eume-chats` | POST | ✅ | Home | 201/409 분기 캐시 미흡 |
| `/api/eume-chats/me` | GET | ✅ | Home | - |
| `/api/eume-chats/{id}/contents` | POST | ✅ | Home | 전송 실패 재시도 UX 없음 |
| `/api/eume-chats/{id}/contents` | GET | ⚠️ | Home | **UI 반영 없음 (핵심)** |

#### 일반 채팅 API (USER_CHAT) - 완료율 0%
| API | HTTP | 상태 | 필요 파일 | 비고 |
|-----|------|------|----------|------|
| `/api/user-chats` | GET | ❌ | Sidebar, Home | 채팅방 목록 |
| `/api/user-chats` | POST | ❌ | Sidebar, Home | 새 채팅방 생성 |
| `/api/user-chats/{id}/contents` | GET | ❌ | Home | 대화 내용 조회 |
| `/api/user-chats/{id}/contents` | POST | ❌ | Home | 메시지 전송 |

#### 관리자 API (ADMIN) - 완료율 80%
| API | HTTP | 상태 | 파일 | 비고 |
|-----|------|------|------|------|
| `/api/admin/login` | POST | ✅ | Login | - |
| `/api/admin/logout` | POST | ✅ | AdminLayout | - |
| `/api/admin/register` | POST | ✅ | Login | - |
| `/api/admin/orgs` | GET | ✅ | Login | 무인증 API |
| `/api/admin/users` | GET | ✅ | Users | - |
| `/api/admin/users/{id}` | GET | ✅ | Users | 상세 모달 연동 |
| `/api/admin/users/{id}/status` | PUT | ❌ | Users | 상태 변경 미구현 |
| `/api/admin/users/{id}/emotions` | GET | ❌ | EmotionMonitor | 감정 데이터 미연동 |
| `/api/admin/users/export` | GET | ✅ | Users | Blob MIME 문제 |
| `/api/admin/reports/summary` | GET | ✅ | Dashboard | 0값 기본치 덮어쓰기 문제 |
| `/api/admin/reports/export` | GET | ✅ | Dashboard | Blob MIME 문제 |

---

### 2.2 페이지별 구현 상태

#### 사용자 페이지
| 페이지 | 상태 | API 연동 | Mock 사용 | 핵심 이슈 |
|--------|------|----------|----------|----------|
| Splash | ✅ | - | - | - |
| Login | ✅ | USER.ME | - | - |
| Onboarding 1-4 | ⚠️ | USER.ME (PUT) | - | 온보딩3 필드 미전달 가능 |
| Home | ⚠️ | EUME_CHAT | pinnedRooms | 과거 대화 로딩, USER_CHAT 전무 |
| Settings | ✅ | USER 전체 | - | - |

#### 관리자 페이지
| 페이지 | 상태 | API 연동 | Mock 사용 | 핵심 이슈 |
|--------|------|----------|----------|----------|
| Login | ✅ | ADMIN 인증 | - | - |
| Dashboard | ✅ | REPORTS | - | 0값 처리, Blob MIME |
| Users | ⚠️ | USERS | 상세 폴백 | status/emotions 미연동 |
| EmotionMonitor | ❌ | - | **전체** | API 연동 전무 |
| Conversation | ❌ | - | **전체** | API 명세 불분명 |
| Emergency | ❌ | - | **전체** | API 명세 불분명, 실시간 필요 |
| Reports | ❌ | - | **전체** | API 명세 불분명 |
| Profile | ✅ | - | - | - |

---

### 2.3 기술 부채 현황 (Codex 분석 기반)

| 항목 | 현재 상태 | 영향도 | 해결 우선순위 |
|------|----------|--------|--------------|
| Blob 응답 처리 | 인터셉터가 Content-Type 제거 | 높음 | Phase 1 |
| chatListId 관리 | 컴포넌트 상태만 저장 | 중간 | Phase 2 |
| 에러 처리 | 페이지별 개별 처리 (alert) | 중간 | Phase 2 |
| 0값 데이터 처리 | nullish 병합 미적용 | 낮음 | Phase 2 |
| Storage 키 정리 | 로그아웃 시 일부 누락 | 낮음 | Phase 1 |
| 온보딩 데이터 | 일부 필드 미전달 가능 | 중간 | Phase 3 |

---

## 3. 구현 계획

### Phase 1: 기반 정비 및 핵심 UX 수정 (1주차)

#### [P1-1] Blob 응답 전용 Axios 인스턴스 생성
**우선순위**: 최상 | **예상 공수**: 0.5일

**문제점**:
- `axiosInstance` 응답 인터셉터가 `response.data`만 반환
- Blob 다운로드 시 Content-Type 정보 손실
- Excel/PDF 파일 인식 실패 가능

**해결 방안**:
```javascript
// src/shared/api/axiosBlob.js (신규)
import axios from 'axios';
import { JAVA_URL } from './config';

const axiosBlob = axios.create({
  baseURL: JAVA_URL,
  timeout: 60000,
  withCredentials: true,
  responseType: 'blob',
});

// 인터셉터 없이 전체 response 반환
export default axiosBlob;
```

**적용 파일**:
- `src/admin/pages/Users.jsx` (Excel 내보내기)
- `src/admin/pages/Dashboard.jsx` (리포트 다운로드)

**검증 방법**:
- [ ] Excel 파일 다운로드 후 정상 열기 확인
- [ ] PDF 파일 다운로드 후 정상 열기 확인
- [ ] 파일 크기 및 MIME 타입 일치 확인

---

#### [P1-2] EUME_CHAT 과거 대화 내역 로딩
**우선순위**: 최상 | **예상 공수**: 1일

**문제점**:
- `GET /api/eume-chats/{id}/contents` API 정의됨
- Home.jsx에서 호출은 하지만 UI 반영 없음
- 새로고침 시 이전 대화 내용 사라짐

**해결 방안**:
```javascript
// Home.jsx - loadExistingChat 함수 수정
const loadExistingChat = async () => {
  setIsLoading(true);
  try {
    // 1. 채팅방 ID 조회
    const chatInfo = await axiosInstance.get(API_ENDPOINTS.EUME_CHAT.ME);
    const chatListId = chatInfo.chatListId;

    // 2. chatListId 캐싱 (재사용)
    localStorage.setItem(STORAGE_KEYS.EUME_CHAT_ID, chatListId);
    setChatListId(chatListId);

    // 3. 과거 대화 내역 로딩
    const contents = await axiosInstance.get(
      API_ENDPOINTS.EUME_CHAT.CONTENTS(chatListId)
    );

    // 4. 메시지 상태에 반영
    setMessagesByRoom(prev => ({
      ...prev,
      [chatListId]: contents.messages || []
    }));
  } catch (error) {
    if (error.response?.status === 404) {
      // 채팅방 없음 - 새로 생성
      await createNewChat();
    }
  } finally {
    setIsLoading(false);
  }
};
```

**적용 파일**: `src/user/pages/Home.jsx`

**검증 방법**:
- [ ] 페이지 새로고침 후 이전 대화 표시
- [ ] 로딩 스피너 정상 표시
- [ ] 채팅방 ID 재사용 확인

---

#### [P1-3] Storage 키 정리 표준화
**우선순위**: 높음 | **예상 공수**: 0.5일

**문제점**:
- 로그아웃/온보딩 흐름에서 일부 임시 키 정리 누락
- OAuth 임시 데이터 잔류 가능

**해결 방안**:
```javascript
// src/shared/constants/storage.js 확장
export const STORAGE_KEYS = {
  // 기존 키들...
  EUME_CHAT_ID: 'eume_chatListId',
  USER_CHAT_IDS: 'user_chatListIds',
};

// 로그아웃 시 정리 함수
export const clearAllUserData = () => {
  Object.values(STORAGE_KEYS).forEach(key => {
    if (key !== STORAGE_KEYS.USER_THEME) { // 테마는 유지
      localStorage.removeItem(key);
    }
  });
};
```

**적용 파일**:
- `src/shared/constants/storage.js`
- `src/user/components/Sidebar.jsx` (handleLogout)
- `src/user/pages/Settings.jsx` (로그아웃/탈퇴)

---

### Phase 2: 채팅 핵심 기능 (2주차)

#### [P2-1] USER_CHAT API 전체 연동
**우선순위**: 최상 | **예상 공수**: 4일

**현재 상태**:
- config.js에 API 정의만 존재
- Sidebar의 pinnedRooms 하드코딩
- 실제 채팅방 관리 기능 전무

**구현 항목**:

1. **채팅방 목록 조회**
```javascript
// GET /api/user-chats
const fetchChatRooms = async () => {
  const rooms = await axiosInstance.get(API_ENDPOINTS.USER_CHAT.LIST);
  setChatRooms(rooms);
};
```

2. **새 채팅방 생성**
```javascript
// POST /api/user-chats
const createChatRoom = async (type) => {
  const newRoom = await axiosInstance.post(API_ENDPOINTS.USER_CHAT.CREATE, {
    chatType: type // 'new-chat', 'policy-info', 'ieum-talk'
  });
  return newRoom.chatListId;
};
```

3. **대화 내용 조회/전송**
```javascript
// GET/POST /api/user-chats/{id}/contents
const loadChatContents = async (chatListId) => {
  return await axiosInstance.get(API_ENDPOINTS.USER_CHAT.CONTENTS(chatListId));
};

const sendMessage = async (chatListId, message) => {
  return await axiosInstance.post(
    API_ENDPOINTS.USER_CHAT.CONTENTS(chatListId),
    { message }
  );
};
```

4. **UI 변경**
- Sidebar: AI 채팅 / 일반 채팅 구분 섹션
- 채팅방 목록 최신순 정렬
- 채팅방 전환 시 내용 로드

**적용 파일**:
- `src/user/components/Sidebar.jsx`
- `src/user/pages/Home.jsx`

**검증 방법**:
- [ ] 채팅방 목록 정상 조회
- [ ] 새 채팅방 생성 및 진입
- [ ] 채팅방 간 전환 시 내용 유지
- [ ] 메시지 송수신 정상 동작

---

#### [P2-2] 에러 처리 공통화 및 UX 개선
**우선순위**: 높음 | **예상 공수**: 1.5일

**현재 상태**:
- 페이지별 개별 에러 처리
- alert() 사용으로 UX 저하
- 재시도 로직 없음

**해결 방안**:

1. **Toast 컴포넌트 도입** (Gemini 제안)
```javascript
// src/shared/components/Toast.jsx
const Toast = ({ message, type, onClose }) => {
  useEffect(() => {
    const timer = setTimeout(onClose, 3000);
    return () => clearTimeout(timer);
  }, []);

  return (
    <div className={`toast toast-${type}`}>
      {message}
    </div>
  );
};
```

2. **API 에러 훅 생성**
```javascript
// src/shared/hooks/useApiError.js
const useApiError = () => {
  const handleError = (error) => {
    if (error.response?.status === 401) {
      // 이미 인터셉터에서 처리
      return;
    }
    if (error.response?.status >= 500) {
      showToast('서버 오류가 발생했습니다. 잠시 후 다시 시도해주세요.', 'error');
    } else {
      showToast(error.response?.data?.message || '요청 처리 중 오류가 발생했습니다.', 'warning');
    }
  };
  return { handleError };
};
```

**적용 파일**:
- `src/shared/components/Toast.jsx` (신규)
- `src/shared/hooks/useApiError.js` (신규)
- `src/shared/contexts/ToastContext.jsx` (신규)

---

### Phase 3: 관리자 모니터링 기능 (3주차)

#### [P3-1] 이용자 상태 변경 기능
**우선순위**: 높음 | **예상 공수**: 0.5일

**구현 내용**:
```javascript
// Users.jsx - 상태 변경 함수
const handleStatusChange = async (userId, newStatus) => {
  try {
    await axiosInstance.put(
      API_ENDPOINTS.ADMIN.USER_STATUS(userId),
      { status: newStatus }
    );
    showToast('상태가 변경되었습니다.', 'success');
    fetchUsers(); // 목록 갱신
  } catch (error) {
    handleError(error);
  }
};
```

**적용 파일**: `src/admin/pages/Users.jsx`

---

#### [P3-2] 감정 모니터링 API 연동
**우선순위**: 높음 | **예상 공수**: 3일

**현재 상태**:
- EmotionMonitor.jsx 전체가 하드코딩 Mock
- emotionStats, emotionDistribution, userEmotions 모두 가짜

**구현 내용**:

1. **개별 이용자 감정 조회**
```javascript
const fetchUserEmotions = async (userId) => {
  return await axiosInstance.get(API_ENDPOINTS.ADMIN.USER_EMOTIONS(userId));
};
```

2. **전체 통계 집계** (백엔드 API 확인 필요)
```javascript
// 방법 1: 전용 API가 있는 경우
const fetchEmotionsSummary = async () => {
  return await axiosInstance.get('/api/admin/emotions/summary');
};

// 방법 2: 없는 경우 - 개별 조회 후 프론트 집계
const aggregateEmotions = async () => {
  const users = await axiosInstance.get(API_ENDPOINTS.ADMIN.USERS);
  const emotionsPromises = users.map(u => fetchUserEmotions(u.id));
  const allEmotions = await Promise.all(emotionsPromises);
  return calculateStats(allEmotions);
};
```

**백엔드 확인 필요**:
- 전체 감정 통계 API 존재 여부
- `GET /api/admin/users` 응답에 최근 감정 포함 여부

**적용 파일**: `src/admin/pages/EmotionMonitor.jsx`

---

#### [P3-3] Dashboard 0값 처리 개선
**우선순위**: 중간 | **예상 공수**: 0.5일

**문제점** (Codex 발견):
- API 응답이 0일 때 기본값으로 덮어쓰기
- 실제 0 데이터가 무시됨

**해결 방안**:
```javascript
// 수정 전
const totalUsers = response.totalUsers || 100;

// 수정 후 (nullish 병합)
const totalUsers = response.totalUsers ?? 0;
```

**적용 파일**: `src/admin/pages/Dashboard.jsx`

---

### Phase 4: 관리자 분석 기능 (4주차)

#### [P4-1] 대화 분석 페이지 API 연동
**우선순위**: 중간 | **예상 공수**: 5일

**백엔드 협의 필요 사항**:
1. 관리자용 대화 목록 API 존재 여부
2. 필터링 파라미터 (이용자ID, 기간, 감정, 키워드)
3. 대화 분석 결과 포함 여부 (감정, 키워드 추출)

**예상 API 스펙**:
```
GET /api/admin/conversations
  ?userId={userId}
  &startDate={date}
  &endDate={date}
  &emotion={emotion}
  &page={page}
  &size={size}

GET /api/admin/conversations/{id}
  -> 대화 상세 + 분석 결과
```

**적용 파일**: `src/admin/pages/Conversation.jsx`

---

#### [P4-2] 긴급 상황 모니터링 API 연동
**우선순위**: 중간 | **예상 공수**: 7일 (실시간 포함)

**백엔드 협의 필요 사항**:
1. 긴급 알림 API 존재 여부
2. 실시간 데이터 전송 방식 (WebSocket/SSE/Polling)
3. 활성 사용자 조회 API

**실시간 구현 옵션** (Gemini 제안):
| 방식 | 장점 | 단점 | 권장 상황 |
|------|-----|------|----------|
| WebSocket | 양방향, 즉시 반응 | 구현 복잡 | 긴급 알림 |
| SSE | 단순, 자동 재연결 | 단방향만 | 활성 사용자 |
| Polling | 가장 단순 | 지연, 부하 | MVP |

**적용 파일**: `src/admin/pages/Emergency.jsx`

---

#### [P4-3] 보고서 페이지 기획 및 구현
**우선순위**: 낮음 | **예상 공수**: 미정 (기획 후 결정)

**기획 협의 필요**:
- 정기 자동 생성 vs 관리자 수동 생성
- 보고서 종류 및 포맷
- 생성 파라미터 (기간, 대상, 내용)

**적용 파일**: `src/admin/pages/Reports.jsx`

---

### Phase 5: 품질 개선 및 고도화 (5주차+)

#### [P5-1] 온보딩 데이터 전달 검증
**예상 공수**: 0.5일

- Onboarding3 수집 필드가 Onboarding4 PUT 요청에 포함되는지 확인
- 누락 필드 있으면 추가
- 백엔드 스키마 매핑 검증

**적용 파일**: `src/user/pages/Onboarding4.jsx`

---

#### [P5-2] 라우터 보호 강화 (Gemini 제안)
**예상 공수**: 1일

- 사용자 페이지에도 인증 가드 적용
- `ProtectedRoute` 컴포넌트 구현
- 미인증 접근 시 로그인 리다이렉트

---

#### [P5-3] 데이터 패칭 라이브러리 도입 검토 (Gemini 제안)
**예상 공수**: 3일

**후보**:
- React Query (TanStack Query)
- SWR

**장점**:
- 자동 캐싱 및 재검증
- 로딩/에러 상태 관리 간소화
- 자동 재시도

---

## 4. 백엔드 협의 필요 사항 (종합)

### 4.1 API 존재 여부 확인

| 기능 | 필요 API | 우선순위 |
|------|---------|---------|
| 감정 통계 | `GET /api/admin/emotions/summary` | 높음 |
| 대화 목록 | `GET /api/admin/conversations` | 중간 |
| 대화 상세 | `GET /api/admin/conversations/{id}` | 중간 |
| 긴급 알림 | `GET /api/admin/emergencies` | 중간 |
| 긴급 상태 변경 | `PUT /api/admin/emergencies/{id}` | 중간 |
| 활성 사용자 | `GET /api/admin/users/active` | 중간 |
| 실시간 연결 | WebSocket/SSE 엔드포인트 | 중간 |

### 4.2 응답 형식 확인

| API | 확인 항목 |
|-----|---------|
| `GET /api/admin/users/{id}/emotions` | 데이터 구조 (시간별 추이, 분포) |
| `PUT /api/admin/users/{id}/status` | 요청/응답 형식, 사유 필드 |
| `GET /api/user-chats` | 채팅방 목록 구조 |
| `GET /api/user-chats/{id}/contents` | 메시지 목록 구조 |
| `GET /api/admin/users` | 최근 감정 상태 포함 여부 |

---

## 5. 구현 일정 요약

```
Week 1: Phase 1 - 기반 정비
├── [P1-1] Blob 처리 (0.5일)
├── [P1-2] EUME_CHAT 과거 대화 (1일)
└── [P1-3] Storage 정리 (0.5일)

Week 2: Phase 2 - 채팅 핵심
├── [P2-1] USER_CHAT 전체 (4일)
└── [P2-2] 에러 처리/Toast (1.5일)

Week 3: Phase 3 - 관리자 모니터링
├── [P3-1] 이용자 상태 변경 (0.5일)
├── [P3-2] 감정 모니터링 (3일)
└── [P3-3] Dashboard 0값 처리 (0.5일)

Week 4: Phase 4 - 관리자 분석
├── [P4-1] 대화 분석 (5일)
└── 백엔드 협의 병행

Week 5+: Phase 4 계속 + Phase 5
├── [P4-2] 긴급 상황 (7일)
├── [P4-3] 보고서 (미정)
└── [P5-*] 품질 개선
```

---

## 6. 검증 체크리스트

### 채팅 기능
- [ ] EUME_CHAT: 새로고침 후 과거 대화 표시
- [ ] EUME_CHAT: 메시지 전송 실패 시 재시도 가능
- [ ] USER_CHAT: 채팅방 목록 정상 조회
- [ ] USER_CHAT: 새 채팅방 생성 및 진입
- [ ] USER_CHAT: 채팅방 전환 시 대화 내용 유지
- [ ] USER_CHAT: AI 채팅과 일반 채팅 UI 구분

### 관리자 기능
- [ ] 이용자 상태 변경 후 목록 반영
- [ ] 감정 모니터링 실데이터 표시
- [ ] 대화 분석 실데이터 표시 (API 확정 후)
- [ ] 긴급 상황 실시간 업데이트 (API 확정 후)

### 다운로드
- [ ] Excel 파일 정상 다운로드 및 열기
- [ ] PDF 파일 정상 다운로드 및 열기
- [ ] 파일 크기 및 MIME 타입 일치

### 에러 처리
- [ ] 401 에러 시 로그인 리다이렉트
- [ ] 네트워크 오류 시 Toast 알림
- [ ] 서버 오류 시 재시도 안내
- [ ] alert() 대신 Toast 사용

### 데이터 품질
- [ ] 0값 데이터 정상 표시 (덮어쓰기 없음)
- [ ] 온보딩 데이터 백엔드 정상 전달
- [ ] Storage 키 로그아웃 시 정상 정리

---

## 7. 참고 파일

### API 관련
- `src/shared/api/config.js` - API 엔드포인트 정의
- `src/shared/api/axios.js` - 인증 인터셉터
- `src/shared/api/axiosRaw.js` - 순수 API 호출
- `src/shared/api/axiosBlob.js` - Blob 다운로드용 (신규)

### 사용자 페이지
- `src/user/pages/Home.jsx` - 채팅 메인
- `src/user/components/Sidebar.jsx` - 사이드바
- `src/user/pages/Settings.jsx` - 설정
- `src/user/pages/Onboarding1-4.jsx` - 온보딩

### 관리자 페이지
- `src/admin/pages/Dashboard.jsx` - 대시보드
- `src/admin/pages/Users.jsx` - 이용자 관리
- `src/admin/pages/Conversation.jsx` - 대화 분석 (Mock)
- `src/admin/pages/EmotionMonitor.jsx` - 감정 모니터 (Mock)
- `src/admin/pages/Emergency.jsx` - 긴급 상황 (Mock)
- `src/admin/pages/Reports.jsx` - 보고서 (Mock)

### 공통 컴포넌트 (신규 예정)
- `src/shared/components/Toast.jsx`
- `src/shared/hooks/useApiError.js`
- `src/shared/contexts/ToastContext.jsx`

---

## 8. 변경 이력

| 날짜 | 버전 | 작성자 | 내용 |
|------|------|--------|------|
| 2025-11-28 | 1.0 | Claude | 초안 작성 |
| 2025-11-28 | 1.0 | Codex | 초안 작성 |
| 2025-11-28 | 1.0 | Gemini | 초안 작성 |
| 2025-11-28 | 2.0 | Claude | v1 3개 종합 |
| 2025-11-28 | 2.0 | Codex | v1 3개 종합 |
| 2025-11-28 | 2.0 | Gemini | v1 3개 종합 |
| 2025-11-28 | **3.0** | **Claude** | **v1+v2 6개 문서 최종 종합** |
