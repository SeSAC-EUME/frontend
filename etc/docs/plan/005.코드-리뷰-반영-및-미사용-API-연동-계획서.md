# 코드 리뷰 반영 및 미사용 API 연동 계획서
<!-- Encoding: UTF-8 (no BOM), Line Ending: CRLF -->

> **문서 버전**: 005
> **작성일**: 2025-11-28
> **작성자**: Claude Code
> **목적**: Codex/Gemini 코드 리뷰 반영 + 미사용 API 연동

---

## 1. 개요

### 1.1 배경
004 계획서의 핵심 작업(10개)이 100% 완료된 후, Codex와 Gemini가 각 커밋에 대해 코드 리뷰를 수행했습니다. 본 계획서는 리뷰에서 발견된 문제점 수정과 아직 연동하지 않은 백엔드 API 구현을 다룹니다.

### 1.2 리뷰 파일 목록
| 커밋 | Codex 리뷰 | Gemini 리뷰 |
|------|-----------|-------------|
| 424e1e5 | codex-001-424e1e5.md | gemini-001-424e1e57.md |
| 59cec49 | codex-002-59cec49.md | gemini-002-59cec492.md |
| 7fcb0a5 | codex-003-7fcb0a5.md | gemini-003-7fcb0a52.md |
| fcc2a2b | codex-004-fcc2a2b.md | gemini-004-fcc2a2b0.md |

---

## 2. 리뷰 문제점 요약

### 2.1 심각도: 높음 (기능 오류)

| # | 문제 | 출처 | 대상 파일 |
|---|------|------|----------|
| H1 | Onboarding3 데이터가 Onboarding4에서 백엔드로 전달되지 않음 | codex-001 | `Onboarding4.jsx` |
| H2 | 기존 채팅 내역이 UI에 반영되지 않음 | codex-002, gemini-002 | `Home.jsx` |
| H3 | Settings 테마 변경 시 ThemeContext 미갱신 | codex-002 | `Settings.jsx` |
| H4 | Splash 온보딩 분기 오류 (hasVisited만 체크) | codex-003 | `Splash.jsx` |
| H5 | Emergency 실시간 타이머 클린업 누락 | codex-004 | `Emergency.jsx` |

### 2.2 심각도: 중간 (데이터 누수/일관성)

| # | 문제 | 출처 | 대상 파일 |
|---|------|------|----------|
| M1 | 로그아웃 시 OAuth 임시 데이터 미삭제 | codex-002, codex-003 | `Sidebar.jsx`, `Settings.jsx` |
| M2 | Profile 저장 시 STORAGE_KEYS 대신 리터럴 사용 | codex-004 | `Profile.jsx` |
| M3 | Onboarding3에서 STORAGE_KEYS 미사용 | 코드 분석 | `Onboarding3.jsx` |

### 2.3 심각도: 낮음 (성능/코드 품질)

| # | 문제 | 출처 | 대상 파일 |
|---|------|------|----------|
| L1 | 메시지 전송 시 매번 chatListId API 호출 | gemini-002 | `Home.jsx` |
| L2 | 한글 주석 인코딩 깨짐 | gemini-001~004 | 여러 파일 |

---

## 3. 미사용 API 목록

### 3.1 사용자 API
| 엔드포인트 | 용도 | 필요 UI |
|-----------|------|---------|
| `POST /api/users/me/withdraw` | 회원 탈퇴 | Settings 페이지 |
| `POST /api/users/me/deactivate` | 계정 비활성화 | Settings 페이지 |

### 3.2 채팅 API
| 엔드포인트 | 용도 | 필요 UI |
|-----------|------|---------|
| `GET /api/user-chats` | 다중 채팅방 목록 | Home 채팅 히스토리 |
| `POST /api/user-chats` | 다중 채팅방 생성 | Home 새 채팅 버튼 |
| `POST /api/user-chats/{id}/contents` | 다중 채팅 메시지 | Home 채팅 UI |

### 3.3 관리자 API
| 엔드포인트 | 용도 | 필요 UI |
|-----------|------|---------|
| `GET /api/admin/users/{userId}` | 사용자 상세 조회 | Users 모달 |
| `PUT /api/admin/users/{userId}/status` | 사용자 상태 변경 | Users 페이지 |
| `GET /api/admin/users/{userId}/emotions` | 사용자 감정 조회 | EmotionMonitor |

---

## 4. 작업 목록

### 4.1 Phase 1: 리뷰 문제점 수정 (우선순위: 긴급)

| # | 작업 | 대상 파일 | 예상 복잡도 |
|---|------|----------|------------|
| 1 | Onboarding3→4 데이터 전달 수정 | `Onboarding3.jsx`, `Onboarding4.jsx` | 중 |
| 2 | 채팅 내역 로드 및 UI 반영 | `Home.jsx` | 중 |
| 3 | Settings ThemeContext setTheme 호출 추가 | `Settings.jsx` | 낮 |
| 4 | Splash 온보딩 분기 로직 수정 | `Splash.jsx` | 낮 |
| 5 | Emergency 타이머 클린업 추가 | `Emergency.jsx` | 낮 |
| 6 | 로그아웃 시 모든 임시 데이터 삭제 | `Sidebar.jsx`, `Settings.jsx` | 낮 |
| 7 | Profile STORAGE_KEYS 사용 | `Profile.jsx` | 낮 |
| 8 | Onboarding3 STORAGE_KEYS 사용 | `Onboarding3.jsx` | 낮 |
| 9 | chatListId state 관리 (성능 개선) | `Home.jsx` | 낮 |

### 4.2 Phase 2: 미사용 API 연동 (우선순위: 높음)

| # | 작업 | 대상 파일 | 예상 복잡도 |
|---|------|----------|------------|
| 10 | 회원 탈퇴/비활성화 기능 | `Settings.jsx` | 중 |
| 11 | Users 모달 실시간 API 연동 | `Users.jsx` | 중 |
| 12 | USER_CHAT 다중 채팅 기능 (선택) | `Home.jsx` 또는 새 페이지 | 높 |

---

## 5. 상세 구현 가이드

### 5.1 [긴급] Onboarding3→4 데이터 전달 수정

**문제**: Onboarding3에서 수집한 정보(이메일, 이름, 생년월일, 성별, 전화번호)가 Onboarding4의 `PUT /api/users/me` 요청에 포함되지 않음

**파일**: `src/user/pages/Onboarding3.jsx`, `src/user/pages/Onboarding4.jsx`

#### 5.1.1 Onboarding3.jsx 수정 (STORAGE_KEYS 사용)

```javascript
// 변경 전 (리터럴 키 사용)
localStorage.setItem('eume_email', formData.email);
localStorage.setItem('eume_realName', formData.userName);
localStorage.setItem('eume_birthDate', formData.birthDate);
localStorage.setItem('eume_gender', formData.gender);
localStorage.setItem('eume_phone', formData.phone);

// 변경 후 (STORAGE_KEYS 사용)
import { STORAGE_KEYS } from '../../shared/constants/storage';
// ...
localStorage.setItem(STORAGE_KEYS.OAUTH_EMAIL, formData.email);
localStorage.setItem(STORAGE_KEYS.OAUTH_REALNAME, formData.userName);
localStorage.setItem(STORAGE_KEYS.OAUTH_BIRTHDATE, formData.birthDate);
localStorage.setItem(STORAGE_KEYS.OAUTH_GENDER, formData.gender);
localStorage.setItem(STORAGE_KEYS.OAUTH_PHONE, formData.phone);
```

#### 5.1.2 Onboarding4.jsx 수정 (프로필 데이터 포함)

```javascript
const handleComplete = async () => {
  try {
    // localStorage에서 OAuth2 사용자 정보 가져오기
    const oauthUser = JSON.parse(
      localStorage.getItem(STORAGE_KEYS.OAUTH_USER) || '{}'
    );
    const userName = localStorage.getItem(STORAGE_KEYS.OAUTH_REALNAME) || oauthUser.name || '';
    const nickname = localStorage.getItem(STORAGE_KEYS.OAUTH_USERNAME) || userName;
    const email = localStorage.getItem(STORAGE_KEYS.OAUTH_EMAIL) || oauthUser.email || '';
    const birthDate = localStorage.getItem(STORAGE_KEYS.OAUTH_BIRTHDATE) || '';
    const gender = localStorage.getItem(STORAGE_KEYS.OAUTH_GENDER) || '';
    const phone = localStorage.getItem(STORAGE_KEYS.OAUTH_PHONE) || '';

    // 프로필 업데이트 데이터 구성 (모든 수집 정보 포함)
    const profileData = {
      userName: userName,
      nickName: nickname,  // 백엔드 필드명 camelCase 주의
      email: email,
      birthDate: birthDate || null,  // YYYY-MM-DD 형식
      gender: gender ? gender.toUpperCase() : null,  // MALE/FEMALE/OTHER
      phone: phone ? phone.replace(/-/g, '') : null,  // 하이픈 제거
      backgroundTheme: toBackendTheme(selectedTheme),
    };

    // PUT /api/users/me 호출
    const result = await axiosInstance.put(API_ENDPOINTS.USER.ME, profileData);
    // ... 나머지 로직
  } catch (error) {
    // ... 에러 처리
  }
};
```

---

### 5.2 [긴급] 채팅 내역 로드 및 UI 반영

**문제**: `loadExistingChat`에서 기존 채팅 내역을 콘솔에만 출력하고 상태에 반영하지 않음

**파일**: `src/user/pages/Home.jsx`

#### 5.2.1 chatListId state 추가 및 loadExistingChat 수정

```javascript
function Home() {
  // ... 기존 state
  const [chatListId, setChatListId] = useState(null);  // 추가: 채팅방 ID 상태

  // Eume AI 채팅방 생성 또는 조회
  const initializeEumeChat = async () => {
    try {
      const response = await axiosRaw.post(API_ENDPOINTS.EUME_CHAT.CREATE);
      if (response.status === 201) {
        console.log('Eume 채팅방 생성:', response.data);
        setChatListId(response.data.id);  // 채팅방 ID 저장
      }
    } catch (error) {
      if (error.response?.status === 409) {
        console.log('기존 Eume 채팅방 사용');
        await loadExistingChat();
      } else {
        console.error('채팅방 초기화 오류:', error);
      }
    }
  };

  // 기존 채팅 내역 로드 (수정)
  const loadExistingChat = async () => {
    try {
      const chatInfo = await axiosInstance.get(API_ENDPOINTS.EUME_CHAT.ME);
      console.log('기존 채팅 정보:', chatInfo);

      // 채팅방 ID 저장
      if (chatInfo.id) {
        setChatListId(chatInfo.id);
      }

      // 채팅 내역이 있으면 메시지 상태에 반영
      if (chatInfo.contents && chatInfo.contents.length > 0) {
        const loadedMessages = chatInfo.contents.map((content, index) => ({
          id: `loaded-${content.id || index}`,
          text: content.messageContent,
          sender: content.messageType === 'USER' ? 'user' : 'ai',
          timestamp: new Date(content.createdAt).toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit',
          }),
        }));

        setMessagesByRoom((prev) => ({
          ...prev,
          'ieum-talk': loadedMessages,
        }));
      }
    } catch (error) {
      console.error('채팅 내역 로드 오류:', error);
    }
  };

  // 메시지 전송 함수 수정 (chatListId state 사용)
  const handleSendMessage = async () => {
    // ... 기존 유효성 검사

    // chatListId가 없으면 조회
    let currentChatListId = chatListId;
    if (!currentChatListId) {
      try {
        const chatInfo = await axiosInstance.get(API_ENDPOINTS.EUME_CHAT.ME);
        currentChatListId = chatInfo.id;
        setChatListId(currentChatListId);
      } catch (error) {
        console.error('채팅방 ID 조회 오류:', error);
        return;
      }
    }

    // API 호출 (state의 chatListId 사용)
    const response = await axiosInstance.post(
      API_ENDPOINTS.EUME_CHAT.CONTENTS(currentChatListId),
      { messageContent: userMessage }
    );
    // ... 나머지 로직
  };
}
```

---

### 5.3 [긴급] Settings ThemeContext setTheme 호출 추가

**문제**: 테마 변경 시 `ThemeContext`의 `setTheme`을 호출하지 않아 다른 화면에서 즉시 반영되지 않음

**파일**: `src/user/pages/Settings.jsx`

```javascript
// 변경 전
const { theme: currentTheme } = useTheme();

// 변경 후
const { theme: currentTheme, setTheme } = useTheme();

// applyTheme 함수 내에 추가
const applyTheme = async () => {
  const themeValue = selectedTheme;

  // ThemeContext 업데이트 (추가)
  setTheme(themeValue);

  // ... 나머지 로직 (body class, localStorage, 백엔드 동기화)
};
```

---

### 5.4 [긴급] Splash 온보딩 분기 로직 수정

**문제**: `hasVisited`만 체크하여 온보딩 완료 여부와 무관하게 홈으로 이동

**파일**: `src/user/pages/Splash.jsx`

```javascript
// 변경 전 (잘못된 로직)
if (!onboardingComplete && !hasVisited) {
  navigate('/user/onboarding-1');
  return;
}

// 변경 후 (올바른 로직)
// 로그인 됨 + 온보딩 미완료 -> 온보딩 페이지
if (!onboardingComplete) {
  navigate('/user/onboarding-1');
  return;
}

// 로그인 됨 + 온보딩 완료 -> 홈 페이지
navigate('/user/home');
```

---

### 5.5 [긴급] Emergency 타이머 클린업 추가

**문제**: `useEffect`에서 `startRealtimeUpdates()` 호출 후 클린업 함수를 반환하지 않음

**파일**: `src/admin/pages/Emergency.jsx`

```javascript
// 변경 전
useEffect(() => {
  initializeData();
  startRealtimeUpdates();
}, []);

// 변경 후
useEffect(() => {
  initializeData();
  const cleanup = startRealtimeUpdates();
  return cleanup;  // 클린업 함수 반환
}, []);
```

---

### 5.6 [중간] 로그아웃 시 모든 임시 데이터 삭제

**문제**: OAuth 온보딩 임시 키들이 로그아웃 시 삭제되지 않음

**파일**: `src/user/components/Sidebar.jsx`, `src/user/pages/Settings.jsx`

```javascript
// handleLogout / logout 함수에 추가
const handleLogout = async () => {
  // ... API 호출

  // localStorage 정리 (기존)
  localStorage.removeItem(STORAGE_KEYS.USER_INFO);
  localStorage.removeItem(STORAGE_KEYS.USER_THEME);
  localStorage.removeItem(STORAGE_KEYS.USER_ONBOARDING);
  localStorage.removeItem(STORAGE_KEYS.USER_VISITED);
  localStorage.removeItem(STORAGE_KEYS.OAUTH_USER);

  // OAuth 임시 데이터 추가 삭제 (추가)
  localStorage.removeItem(STORAGE_KEYS.OAUTH_EMAIL);
  localStorage.removeItem(STORAGE_KEYS.OAUTH_REALNAME);
  localStorage.removeItem(STORAGE_KEYS.OAUTH_USERNAME);
  localStorage.removeItem(STORAGE_KEYS.OAUTH_BIRTHDATE);
  localStorage.removeItem(STORAGE_KEYS.OAUTH_GENDER);
  localStorage.removeItem(STORAGE_KEYS.OAUTH_PHONE);

  // 설정 데이터 삭제 (Settings.jsx에만)
  localStorage.removeItem('eume_settings');

  // ... 나머지 로직
};
```

---

### 5.7 [중간] Profile STORAGE_KEYS 사용

**문제**: `saveProfile`에서 `'eume_admin_user'` 리터럴 문자열 사용

**파일**: `src/admin/pages/Profile.jsx`

```javascript
// 변경 전
localStorage.setItem('eume_admin_user', JSON.stringify(updatedUser));

// 변경 후
localStorage.setItem(STORAGE_KEYS.ADMIN_USER, JSON.stringify(updatedUser));
```

---

### 5.8 [높음] 회원 탈퇴/비활성화 기능

**파일**: `src/user/pages/Settings.jsx`

#### 5.8.1 UI 추가 (계정 관리 섹션)

```jsx
{/* 계정 관리 섹션 (기존 로그아웃 버튼 아래에 추가) */}
<div className="settings-section">
  <h3 className="section-title">계정 관리</h3>

  <button className="settings-button warning" onClick={handleDeactivate}>
    계정 비활성화
  </button>
  <p className="settings-description">
    계정을 일시적으로 비활성화합니다. 언제든 다시 로그인하여 활성화할 수 있습니다.
  </p>

  <button className="settings-button danger" onClick={handleWithdraw}>
    회원 탈퇴
  </button>
  <p className="settings-description">
    모든 데이터가 삭제되며 복구할 수 없습니다.
  </p>
</div>
```

#### 5.8.2 핸들러 함수 추가

```javascript
// 계정 비활성화
const handleDeactivate = async () => {
  if (!window.confirm('계정을 비활성화하시겠습니까?\n언제든 다시 로그인하여 활성화할 수 있습니다.')) {
    return;
  }

  try {
    await axiosInstance.post(API_ENDPOINTS.USER.DEACTIVATE);
    alert('계정이 비활성화되었습니다.');
    // 로그아웃 처리
    logout();
  } catch (error) {
    if (error.response?.status === 409) {
      alert('이미 비활성화된 계정입니다.');
    } else {
      alert('계정 비활성화 중 오류가 발생했습니다.');
    }
  }
};

// 회원 탈퇴
const handleWithdraw = async () => {
  const confirmMessage = '정말 탈퇴하시겠습니까?\n\n⚠️ 모든 데이터가 영구적으로 삭제되며 복구할 수 없습니다.';
  if (!window.confirm(confirmMessage)) {
    return;
  }

  // 2차 확인
  const finalConfirm = window.prompt('탈퇴를 진행하려면 "탈퇴합니다"를 입력해주세요.');
  if (finalConfirm !== '탈퇴합니다') {
    alert('입력이 일치하지 않아 탈퇴가 취소되었습니다.');
    return;
  }

  try {
    await axiosInstance.post(API_ENDPOINTS.USER.WITHDRAW);
    alert('회원 탈퇴가 완료되었습니다. 이용해주셔서 감사합니다.');
    // 모든 로컬 데이터 삭제 후 로그인 페이지로
    logout();
  } catch (error) {
    alert('회원 탈퇴 중 오류가 발생했습니다.');
  }
};
```

---

### 5.9 [높음] Users 모달 실시간 API 연동

**파일**: `src/admin/pages/Users.jsx`

#### 5.9.1 viewUserDetail 함수 수정

```javascript
const viewUserDetail = async (userId) => {
  try {
    // API에서 실시간 사용자 상세 정보 조회
    const userDetail = await axiosInstance.get(API_ENDPOINTS.ADMIN.USER_DETAIL(userId));
    setSelectedUserDetail(userDetail);
    setShowUserModal(true);
    document.body.style.overflow = 'hidden';
  } catch (error) {
    console.error('사용자 상세 조회 오류:', error);
    // API 실패 시 로컬 데이터 사용 (폴백)
    const user = usersData.find(u => u.id === userId);
    if (user) {
      setSelectedUserDetail(user);
      setShowUserModal(true);
      document.body.style.overflow = 'hidden';
    } else {
      alert('사용자 정보를 불러올 수 없습니다.');
    }
  }
};
```

---

## 6. 검증 체크리스트

### 6.1 리뷰 문제점 수정 검증

- [ ] Onboarding3 입력 데이터가 백엔드에 저장됨
- [ ] 기존 채팅 내역이 UI에 표시됨
- [ ] Settings 테마 변경이 다른 화면에 즉시 반영됨
- [ ] 온보딩 중단 사용자가 다시 접속 시 온보딩 재개됨
- [ ] Emergency 페이지 이동 시 타이머가 정리됨
- [ ] 로그아웃 후 이전 사용자 데이터가 남아있지 않음

### 6.2 미사용 API 연동 검증

- [ ] 회원 탈퇴 기능이 정상 동작함
- [ ] 계정 비활성화 기능이 정상 동작함
- [ ] Users 모달에서 실시간 데이터가 표시됨

---

## 7. 우선순위 및 일정

| Phase | 작업 | 우선순위 | 예상 소요 |
|-------|------|---------|----------|
| 1 | 리뷰 문제점 수정 (H1~H5, M1~M3, L1) | 긴급 | - |
| 2 | 회원 탈퇴/비활성화 | 높음 | - |
| 3 | Users 모달 API 연동 | 높음 | - |
| 4 | USER_CHAT 다중 채팅 (선택) | 중간 | - |

---

## 변경 이력

| 날짜 | 버전 | 작성자 | 내용 |
|------|------|--------|------|
| 2025-11-28 | 1.0 | Claude Code | 초기 작성 |
