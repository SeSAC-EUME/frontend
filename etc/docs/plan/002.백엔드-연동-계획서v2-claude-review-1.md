# 백엔드-프론트엔드 연동 계획서 v2

> **통합 문서**: 001.백엔드-연동-계획서.md, 001.백엔드-연동-계획서-claude-review-1.md, 001.백엔드-연동-계획서-codex-review-1.md를 통합하고 추가 검토한 최종 계획서

---

## 1. 개요

### 1.1 목적
Spring Boot 백엔드(8080 포트)와 React 프론트엔드(3000 포트) 간의 API 연동을 체계적으로 구현하기 위한 통합 계획서입니다.

### 1.2 현재 상태
- **백엔드**: `http://localhost:8080` (Swagger: `/swagger-ui/index.html`)
- **프론트엔드**: `http://localhost:3000` (Vite 개발 서버)
- **연동 상태**: 부분적 구현, 다수의 불일치 발견

### 1.3 검토 출처
| 문서 | 주요 발견 |
|------|----------|
| 원본 계획서 | 기본 API 구조, 연동 작업 Phase |
| Claude Review | 로그인 요청 형식, 회원가입 API, 테마 불일치 |
| Codex Review | 인증 방식, 호출 도구 혼용, 응답 핸들링 |
| 추가 검토 | localStorage 키 불일치 |

---

## 2. 발견된 문제점 종합

### 2.1 문제점 요약 (심각도 순)

| # | 문제점 | 심각도 | 출처 | 영향 범위 |
|---|--------|--------|------|----------|
| 1 | 관리자 로그인 요청 형식 불일치 | **긴급** | Claude | admin/Login.jsx |
| 2 | 사용자 회원가입 API 없음 | **긴급** | Claude | user/Onboarding4.jsx |
| 3 | API 경로 `/api/` 프리픽스 누락 | **긴급** | Codex | 전체 API 호출 |
| 4 | localStorage 키 불일치 | **높음** | 추가 검토 | 인증 전체 |
| 5 | 인증 방식 불일치 (Bearer vs 쿠키) | **높음** | Codex | axios.js |
| 6 | 테마 값 불일치 | 높음 | Claude | 프로필 저장 |
| 7 | fetch/axiosInstance 혼용 | 중간 | Codex | OAuth2Redirect.jsx |
| 8 | 응답 인터셉터 response.data만 반환 | 중간 | Codex | 상태코드 필요 시 |
| 9 | withCredentials 미설정 | 중간 | Codex | 쿠키 인증 |
| 10 | 누락된 데이터 타입 | 낮음 | Claude | 타입 안정성 |

### 2.2 상세 분석

#### 문제 1: 관리자 로그인 요청 형식 불일치 (긴급)
```javascript
// 현재 코드 (admin/pages/Login.jsx:76-80)
{
  loginId: formData.username,      // ❌ 잘못됨
  password: formData.password,     // ❌ 잘못됨
  loginType: 'LOCAL'               // ❌ 불필요
}

// 백엔드 요구사항 (AdminLoginRequest)
{
  sigunguId: number,    // ✅ 필수 (누락됨!)
  adminLoginId: string, // ✅ 필수
  adminPw: string       // ✅ 필수
}
```
**결과**: 현재 관리자 로그인 기능이 작동하지 않음

#### 문제 2: 사용자 회원가입 API 없음 (긴급)
- `Onboarding4.jsx`에서 `API_ENDPOINTS.USER.REGISTER` 호출
- 백엔드에 `/user/register` API 없음 (OAuth2 기반 자동 가입)
- **결과**: 온보딩 완료 시 에러 발생

#### 문제 3: API 경로 프리픽스 누락 (긴급)
```javascript
// 현재 config.js
ADMIN: {
  LOGIN: `${JAVA_URL}admin/login`,     // ❌ /api/ 누락
}

// 올바른 경로
ADMIN: {
  LOGIN: `${JAVA_URL}api/admin/login`, // ✅
}
```

#### 문제 4: localStorage 키 불일치 (높음)
```javascript
// axios.js에서 사용하는 키
const token = localStorage.getItem('accessToken');  // ❌

// 실제 저장되는 키들 (파일별로 다름!)
localStorage.setItem('token', result.token);           // admin/Login.jsx
localStorage.setItem('eume_user_token', token);        // user/OAuth2Redirect.jsx
```
**결과**: API 호출 시 Authorization 헤더에 토큰이 포함되지 않음

#### 문제 5: 인증 방식 불일치 (높음)
| 항목 | 현재 프론트엔드 | 백엔드 요구사항 |
|------|----------------|----------------|
| 토큰 저장 | localStorage | HttpOnly 쿠키 |
| 요청 방식 | Bearer 헤더 | credentials: include |
| 키 이름 | accessToken (미사용) | sh_access_token (쿠키) |

#### 문제 6: 테마 값 불일치 (높음)
| 프론트엔드 | 백엔드 |
|-----------|--------|
| 'ocean' | 'DEFAULT' |
| 'sunset' | 'DARK' |
| 'forest' | 'LIGHT' |
| 'lavender' | (없음) |
| 'rose' | (없음) |

---

## 3. 수정 작업 계획

### 3.1 Phase 0: 긴급 수정 (즉시)

#### 작업 0.1: API 경로 수정 (`src/shared/api/config.js`)
```javascript
export const API_ENDPOINTS = {
  // 공통
  HEALTH_CHECK: `${JAVA_URL}health-check`,

  // 사용자 API
  USER: {
    ME: `${JAVA_URL}api/users/me`,
    LOGOUT: `${JAVA_URL}api/users/logout`,
    WITHDRAW: `${JAVA_URL}api/users/me/withdraw`,
    DEACTIVATE: `${JAVA_URL}api/users/me/deactivate`,
    // REGISTER 삭제 - 백엔드에 없음
  },

  // Eume AI 채팅 API
  EUME_CHAT: {
    CREATE: `${JAVA_URL}api/eume-chats`,
    ME: `${JAVA_URL}api/eume-chats/me`,
    CONTENTS: (chatListId) => `${JAVA_URL}api/eume-chats/${chatListId}/contents`,
  },

  // 다중 채팅 API
  USER_CHAT: {
    LIST: `${JAVA_URL}api/user-chats`,
    CREATE: `${JAVA_URL}api/user-chats`,
    CONTENTS: (chatListId) => `${JAVA_URL}api/user-chats/${chatListId}/contents`,
  },

  // 관리자 API
  ADMIN: {
    LOGIN: `${JAVA_URL}api/admin/login`,
    LOGOUT: `${JAVA_URL}api/admin/logout`,
    REGISTER: `${JAVA_URL}api/admin/register`,
    ORGS: `${JAVA_URL}api/admin/orgs`,
    USERS: `${JAVA_URL}api/admin/users`,
    USER_DETAIL: (userId) => `${JAVA_URL}api/admin/users/${userId}`,
    USER_STATUS: (userId) => `${JAVA_URL}api/admin/users/${userId}/status`,
    USER_EMOTIONS: (userId) => `${JAVA_URL}api/admin/users/${userId}/emotions`,
    USERS_EXPORT: `${JAVA_URL}api/admin/users/export`,
    REPORTS_SUMMARY: `${JAVA_URL}api/admin/reports/summary`,
    REPORTS_EXPORT: `${JAVA_URL}api/admin/reports/export`,
  },
};
```

#### 작업 0.2: 관리자 로그인 수정 (`src/admin/pages/Login.jsx`)
```javascript
// 수정 전 (Line 76-80)
const result = await axiosInstance.post(API_ENDPOINTS.ADMIN.LOGIN, {
  loginId: formData.username,
  password: formData.password,
  loginType: 'LOCAL'
});

// 수정 후
const result = await axiosInstance.post(API_ENDPOINTS.ADMIN.LOGIN, {
  sigunguId: formData.sigunguId,      // 소속기관 선택 UI 추가 필요
  adminLoginId: formData.username,
  adminPw: formData.password
});
```
**추가 작업**: 소속기관 선택 드롭다운 UI 추가 (GET `/api/admin/orgs` 호출)

#### 작업 0.3: 온보딩 흐름 수정 (`src/user/pages/Onboarding4.jsx`)
```javascript
// 수정 전: USER.REGISTER API 호출 (존재하지 않음)
const result = await axiosInstance.post(API_ENDPOINTS.USER.REGISTER, registerData);

// 수정 후: /api/users/me PUT으로 프로필 업데이트
const result = await axiosInstance.put(API_ENDPOINTS.USER.ME, {
  userName: userName,
  nickName: nickname,
  birthDate: birthDate,
  gender: gender,
  phone: phone,
  backgroundTheme: toBackendTheme(selectedTheme), // 테마 매핑 필요
});
```

### 3.2 Phase 1: 인증 시스템 정비 (높음)

#### 작업 1.1: Axios 인스턴스 수정 (`src/shared/api/axios.js`)
```javascript
const axiosInstance = axios.create({
  baseURL: JAVA_URL,
  timeout: API_CONFIG.timeout,
  headers: API_CONFIG.headers,
  withCredentials: true,  // ✅ 쿠키 인증 추가
});

// 요청 인터셉터 수정
axiosInstance.interceptors.request.use(
  config => {
    // 쿠키 기반 인증으로 전환 시 Bearer 헤더 제거 가능
    // 백엔드 정책에 따라 결정
    return config;
  },
  error => Promise.reject(error)
);

// 응답 인터셉터 수정 (상태코드 접근 가능하도록)
axiosInstance.interceptors.response.use(
  response => response,  // ✅ 전체 응답 반환 (필요 시)
  error => {
    if (error.response?.status === 401) {
      // 사용자/관리자 구분하여 리다이렉트
      const isAdmin = window.location.pathname.startsWith('/admin');
      window.location.href = isAdmin ? '/admin/login' : '/user/login';
    }
    return Promise.reject(error);
  }
);
```

#### 작업 1.2: localStorage 키 통일
```javascript
// 토큰 키 상수 정의 (src/shared/constants/storage.js)
export const STORAGE_KEYS = {
  // 사용자
  USER_TOKEN: 'eume_user_token',
  USER_DATA: 'eume_user',
  USER_THEME: 'eume_theme',
  USER_VISITED: 'eume_visited',
  USER_ONBOARDING: 'eume_onboarding_complete',
  OAUTH_USER: 'eume_oauth_user',

  // 관리자
  ADMIN_TOKEN: 'eume_admin_token',
  ADMIN_USER: 'eume_admin_user',
  ADMIN_SESSION_EXPIRY: 'eume_admin_session_expiry',
  ADMIN_LOGIN_HISTORY: 'eume_admin_login_history',
};
```

#### 작업 1.3: OAuth2Redirect.jsx 수정
```javascript
// 수정 전: fetch 직접 사용
const response = await fetch(`${JAVA_URL}api/users/me`, {
  method: 'GET',
  credentials: 'include',
});

// 수정 후: axiosInstance 사용
const response = await axiosInstance.get(API_ENDPOINTS.USER.ME);
```

### 3.3 Phase 2: 테마 매핑 구현 (높음)

#### 작업 2.1: 테마 매핑 유틸리티 (`src/shared/utils/themeMapper.js`)
```javascript
/**
 * 테마 매핑 유틸리티
 * 프론트엔드 테마와 백엔드 테마 간 변환
 */

const FRONTEND_TO_BACKEND = {
  'ocean': 'DEFAULT',
  'sunset': 'DARK',
  'forest': 'LIGHT',
  'lavender': 'DEFAULT',
  'rose': 'DEFAULT',
};

const BACKEND_TO_FRONTEND = {
  'DEFAULT': 'ocean',
  'DARK': 'sunset',
  'LIGHT': 'forest',
};

export const toBackendTheme = (frontendTheme) =>
  FRONTEND_TO_BACKEND[frontendTheme] || 'DEFAULT';

export const toFrontendTheme = (backendTheme) =>
  BACKEND_TO_FRONTEND[backendTheme] || 'ocean';

// 프론트엔드에서 지원하는 모든 테마
export const FRONTEND_THEMES = ['ocean', 'sunset', 'forest', 'lavender', 'rose'];

// 백엔드에서 지원하는 테마
export const BACKEND_THEMES = ['DEFAULT', 'DARK', 'LIGHT'];
```

### 3.4 Phase 3: 기능별 연동 (중간)

#### 3.4.1 사용자 앱
| 페이지 | 연동 작업 | 우선순위 |
|--------|----------|---------|
| Home.jsx | EumeChat API 연동 | 높음 |
| Settings.jsx | 프로필 조회/수정, 로그아웃 | 높음 |
| Sidebar.jsx | 로그아웃 API 연동 | 중간 |

#### 3.4.2 관리자 앱
| 페이지 | 연동 작업 | 우선순위 |
|--------|----------|---------|
| Login.jsx | 소속기관 드롭다운 추가 | 긴급 |
| Dashboard.jsx | 통계 API 연동 | 중간 |
| Users.jsx | 사용자 목록/상세/상태변경 | 중간 |
| EmotionMonitor.jsx | 감정 기록 조회 | 낮음 |
| Reports.jsx | 보고서 조회/다운로드 | 낮음 |

### 3.5 Phase 4: 품질 개선 (낮음)

- [ ] API 서비스 레이어 분리 (`src/shared/api/services/`)
- [ ] 에러 바운더리 구현
- [ ] 로딩 상태 통일
- [ ] React Query 또는 SWR 도입 검토

---

## 4. 데이터 타입 정의 (통합)

### 4.1 사용자 관련

```typescript
// 프로필 조회 응답
interface EumeUserProfileResponse {
  email: string;
  userName: string;
  nickname: string;
  profileImage: string;
  sigungu: {
    sido: string;
    sigungu: string;
  };
  birthDate: string;
  gender: string;
  phone: string;
  lastLoginDate: string;
  backGroundTheme: 'DEFAULT' | 'DARK' | 'LIGHT';
  createdAt: string;
  updatedAt: string;
}

// 프로필 수정 요청
interface EumeUserUpdateRequest {
  userName?: string;
  nickName?: string;  // 주의: camelCase
  profileImage?: string;
  sigunguId?: number;
  birthDate?: string;
  gender?: string;
  phone?: string;
  backgroundTheme?: 'DEFAULT' | 'DARK' | 'LIGHT';
}
```

### 4.2 채팅 관련

```typescript
// Eume 채팅 메시지 요청
interface EumeChatContentCreateRequest {
  messageContent: string;
}

// Eume 채팅 메시지 응답
interface EumeChatContentCreateResponse {
  userMessage: EumeChatContentResponse;
  eumeMessage: EumeChatContentResponse;
}

interface EumeChatContentResponse {
  id: number;
  messageType: string;
  messageContent: string;
  createdAt: string;
}

// 다중 채팅방 생성 요청
interface UserChatListCreateRequest {
  roomTitle: string; // max 100자
}

// 다중 채팅 메시지 요청
interface UserChatContentCreateRequest {
  messageContent: string;
  messageType: string;
}
```

### 4.3 관리자 관련

```typescript
// 관리자 로그인 요청
interface AdminLoginRequest {
  sigunguId: number;
  adminLoginId: string;
  adminPw: string;
}

// 관리자 로그인 응답
interface AdminLoginResponse {
  id: number;
  adminName: string;
  adminEmail: string;
  lastLoginDate: string;
}

// 관리자 회원가입 요청
interface AdminRegisterRequest {
  sigunguId: number;
  adminLoginId: string; // 4-20자
  adminPw: string;      // 8-100자
  adminName: string;
  adminEmail: string;
  adminPhone?: string;
}

// 소속기관 응답
interface AdminOrgResponse {
  id: number;
  name: string;
}

// 사용자 상태 변경 요청
interface AdminUserStatusUpdateRequest {
  status: 'ACTIVE' | 'DEACTIVATED';
}
```

### 4.4 페이지네이션

```typescript
interface PaginationParams {
  page?: number;  // default: 0
  size?: number;  // default: 20
}

interface PaginatedResponse<T> {
  [dataKey: string]: T[];  // users, chatRooms, contents, emotions 등
  currentPage: number;
  totalPages: number;
  totalElements: number;
  hasNext: boolean;
  hasPrevious: boolean;
}
```

### 4.5 감정 분석 / 보고서

```typescript
interface AdminUserEmotionResponse {
  id: number;
  depressionScore: number;
  anxietyScore: number;
  stressScore: number;
  emotionScore: number;
  keywords: string[];
  analysisDate: string;
  modelVersion: string;
}

interface AdminReportSummaryResponse {
  userActivity: {
    totalUsers: number;
    activeUsers: number;
    newUsers: number;
  };
  conversation: {
    totalConversations: number;
    dailyAvgConversations: number;
    totalMessages: number;
  };
  emotion: {
    needAttentionUsers: number;
    avgEmotionScore: number;
    emotionDistribution: Record<string, number>;
  };
  dailyStats: Array<{
    date: string;
    activeUsers: number;
    conversations: number;
    avgEmotionScore: number;
  }>;
}
```

---

## 5. 작업 우선순위 및 일정

### 즉시 수행 (Day 1)
1. **[긴급]** API 경로 `/api/` 프리픽스 추가
2. **[긴급]** 관리자 로그인 요청 형식 수정
3. **[긴급]** 온보딩 흐름 수정 (REGISTER → PUT /api/users/me)

### 1주차
4. axios.js에 `withCredentials: true` 추가
5. localStorage 키 통일
6. 관리자 로그인 - 소속기관 선택 UI 추가
7. 테마 매핑 유틸리티 구현

### 2주차
8. OAuth2Redirect.jsx → axiosInstance 사용
9. 사용자 Home 페이지 AI 채팅 연동
10. 사용자 Settings 프로필 조회/수정

### 3주차
11. 관리자 Users 페이지 연동
12. 관리자 Dashboard 통계 연동

### 4주차
13. 관리자 EmotionMonitor 연동
14. 관리자 Reports 연동
15. Excel 내보내기 기능

---

## 6. 검증 체크리스트

### 6.1 기능 검증
- [ ] 사용자 OAuth2 로그인 → 프로필 조회 성공
- [ ] 사용자 온보딩 완료 → 프로필 업데이트 성공
- [ ] 사용자 AI 채팅 생성/조회/메시지 전송
- [ ] 사용자 로그아웃
- [ ] 관리자 로그인 (소속기관 선택 포함)
- [ ] 관리자 사용자 목록/상세 조회
- [ ] 관리자 사용자 상태 변경
- [ ] 관리자 보고서 조회/다운로드

### 6.2 기술 검증
- [ ] 모든 API 요청에 `/api/` 프리픽스 포함
- [ ] 쿠키가 요청에 포함되는지 확인 (Network 탭)
- [ ] 401 에러 시 적절한 페이지로 리다이렉트
- [ ] localStorage 키가 통일되었는지 확인
- [ ] 테마 저장/조회 시 매핑이 올바른지 확인

---

## 7. 참고 사항

### 7.1 환경 설정
```env
VITE_API_URL=http://localhost:8080/
```

### 7.2 CORS 설정 (백엔드)
```
Access-Control-Allow-Origin: http://localhost:3000
Access-Control-Allow-Credentials: true
Access-Control-Allow-Methods: GET, POST, PUT, PATCH, DELETE, OPTIONS
Access-Control-Allow-Headers: Content-Type, Authorization
```

### 7.3 Swagger 문서
- UI: http://localhost:8080/swagger-ui/index.html
- JSON: http://localhost:8080/v3/api-docs

---

## 변경 이력

| 날짜 | 버전 | 작성자 | 내용 |
|------|------|--------|------|
| 2025-11-28 | 1.0 | Claude | 원본 계획서 작성 |
| 2025-11-28 | 1.1 | Claude | 검토 후 수정 (로그인 형식, 테마 등) |
| 2025-11-28 | 1.1 | Codex | 검토 후 수정 (인증, 호출 도구 등) |
| 2025-11-28 | 2.0 | Claude | 통합 계획서 작성 (001 파일 3개 통합 + 추가 발견) |

---

## 부록: 001 파일들과의 차이점

### 원본 대비 추가/수정 사항
1. localStorage 키 불일치 문제 추가 (문제 4)
2. 작업 Phase 재구성 (Phase 0 긴급 작업 추가)
3. localStorage 키 상수 정의 추가
4. 검증 체크리스트 추가
5. 상세한 코드 수정 예시 추가

### Claude Review 대비 추가/수정 사항
1. Codex Review 내용 통합 (인증, 응답 인터셉터)
2. localStorage 키 통일 방안 구체화
3. 작업 일정 구체화

### Codex Review 대비 추가/수정 사항
1. Claude Review 내용 통합 (로그인 형식, 테마)
2. 데이터 타입 정의 추가
3. Phase별 작업 계획 구체화
