# 백엔드-프론트 연동 검토 보고서 (codex review 1)

## 1. 개요
- 대상 문서: `etc/docs/001.백엔드-연동-계획서.md` 초안 검토.
- 기준: 프론트 코드(`src/shared/api/config.js`, `src/shared/api/axios.js`, 주요 페이지)와 백엔드 Swagger 기준(`http://localhost:8080/swagger-ui/index.html#/` 가정) 일치 여부 점검.
- 목표: 실제 API 경로·인증 방식 불일치를 정리하고, 수정 방안을 제시.

## 2. 프론트 코드 현황
- 기본 URL: `JAVA_URL = VITE_API_URL || http://localhost:8080/` (슬래시 포함), `axiosInstance`의 `baseURL`로 사용.
- 엔드포인트 정의(`API_ENDPOINTS`): `/api` 프리픽스 없이 `admin/login`, `user/logout` 등 미작성; 사용자/관리자 세부 API 다수 미정의.
- 토큰 처리: `localStorage.getItem('accessToken')`로 Bearer 헤더 추가, `withCredentials` 미설정 → HttpOnly 쿠키 기반 인증과 불일치.
- 호출 패턴: 대부분 `axiosInstance` 사용, `user/pages/OAuth2Redirect.jsx`는 `fetch('/api/users/me')`를 직접 호출해 베이스 URL/인증 일관성 부족.

## 3. 백엔드 Swagger 기준 (요약)
- 공통 프리픽스: `/api/...`
- 주요 경로: 
  - 사용자: `GET/PUT /api/users/me`, `POST /api/users/me/withdraw|deactivate`, `POST /api/users/logout`
  - EumeChat: `POST /api/eume-chats`, `GET /api/eume-chats/me`, `GET/POST /api/eume-chats/{chatListId}/contents`
  - UserChat: `GET/POST /api/user-chats`, `GET/POST /api/user-chats/{chatListId}/contents`
  - 관리자: `POST /api/admin/login|logout|register`, `GET /api/admin/orgs|users|users/{id}|users/{id}/emotions`, `PATCH /api/admin/users/{id}/status`, `GET /api/admin/users/export`, `GET /api/admin/reports/summary|export`
- 인증: HttpOnly 쿠키(`sh_access_token` 등) + `credentials: include` 요구.

## 4. 불일치 및 리스크
1) **경로 불일치**: 프론트 엔드포인트에 `/api/` 프리픽스 누락, Swagger 경로와 다름. 
2) **API 누락**: 채팅(EumeChat/UserChat), 사용자 me/withdraw/deactivate, 관리자 orgs/users/reports/export 등 대부분 미정의.
3) **인증 방식 상이**: 프론트는 로컬스토리지 토큰 + Bearer, 백엔드 계획은 HttpOnly 쿠키 + `credentials: include`.
4) **호출 도구 혼용**: `fetch('/api/users/me')`와 `axiosInstance` 혼재로 인터셉터/에러 처리 일관성 깨짐.
5) **프론트 응답 핸들링**: `axiosInstance`가 `response.data`만 반환 → 필요 시 상태코드 확인이 불가함. 로그인/에러 분기 시 주의 필요.

## 5. 수정 제안 (반영안)
- `src/shared/api/config.js`를 Swagger 기준으로 재정의:
```javascript
export const API_ENDPOINTS = {
  USER: {
    ME: `${JAVA_URL}api/users/me`,
    LOGOUT: `${JAVA_URL}api/users/logout`,
    WITHDRAW: `${JAVA_URL}api/users/me/withdraw`,
    DEACTIVATE: `${JAVA_URL}api/users/me/deactivate`,
  },
  EUME_CHAT: {
    CREATE: `${JAVA_URL}api/eume-chats`,
    ME: `${JAVA_URL}api/eume-chats/me`,
    CONTENTS: chatListId => `${JAVA_URL}api/eume-chats/${chatListId}/contents`,
  },
  USER_CHAT: {
    LIST: `${JAVA_URL}api/user-chats`,
    CREATE: `${JAVA_URL}api/user-chats`,
    CONTENTS: chatListId => `${JAVA_URL}api/user-chats/${chatListId}/contents`,
  },
  ADMIN: {
    LOGIN: `${JAVA_URL}api/admin/login`,
    LOGOUT: `${JAVA_URL}api/admin/logout`,
    REGISTER: `${JAVA_URL}api/admin/register`,
    ORGS: `${JAVA_URL}api/admin/orgs`,
    USERS: `${JAVA_URL}api/admin/users`,
    USER_DETAIL: userId => `${JAVA_URL}api/admin/users/${userId}`,
    USER_STATUS: userId => `${JAVA_URL}api/admin/users/${userId}/status`,
    USER_EMOTIONS: userId => `${JAVA_URL}api/admin/users/${userId}/emotions`,
    USERS_EXPORT: `${JAVA_URL}api/admin/users/export`,
    REPORTS_SUMMARY: `${JAVA_URL}api/admin/reports/summary`,
    REPORTS_EXPORT: `${JAVA_URL}api/admin/reports/export`,
  },
};
```
- `axiosInstance`에 `withCredentials: true` 추가, 쿠키 기반 인증으로 통일. 백엔드가 Bearer 토큰을 요구하지 않으면 Authorization 헤더 제거 검토.
- `OAuth2Redirect.jsx` 등 `fetch` 사용 부분을 `axiosInstance`로 교체해 베이스 URL/인증/에러 처리 일관성 확보.
- 쿠키/로컬스토리지 정책 결정: 쿠키 사용 시 `localStorage accessToken` 의존 제거, 401 처리 시 리다이렉트만 수행.
- 필요 시 응답 상태를 확인해야 하는 로그인/회원가입 흐름에서는 `axiosInstance`가 `response.data`만 반환하는 인터셉터를 조정하거나 특정 호출만 원본 응답을 반환하도록 예외 처리.

## 6. 검증 플로우 제안
- 프론트 수정 후 `npm run dev` 환경에서 다음 순서로 수동 검증:
  1) 사용자 로그인/OAuth2 리다이렉트 후 `GET /api/users/me` 성공 여부 (쿠키 세션 확인).
  2) 사용자 홈: `GET /api/eume-chats/me`, 기존 채팅 목록 표시 → `POST /api/eume-chats`로 새 채팅 생성 → 콘텐츠 조회/전송 정상.
  3) 설정 페이지: 프로필 조회/수정, 탈퇴/비활성화 요청 정상.
  4) 관리자 로그인 후 조직/사용자 목록, 상태 변경, 보고서 요약/다운로드, 감정 모니터링 조회.
  5) 네트워크 탭에서 모든 요청이 `/api/...` 경로이며 쿠키가 포함되는지 확인.

## 7. 메모
- `.env.example`의 `VITE_API_URL`은 백엔드 기본 URL(끝에 `/`)로 유지. 환경별 경로는 모두 `/api/`를 포함하도록 프론트에서 책임.
- Swagger 스펙이 변경되면 `API_ENDPOINTS`와 타입 정의(인터페이스)도 즉시 갱신.

## 8. 변경 이력
| 일시 | 버전 | 작성자 | 내용 |
|------|------|--------|------|
| 2025-11-28 | 1.1 | Codex | 프론트/백엔드 불일치 검토 및 수정안 반영 |
