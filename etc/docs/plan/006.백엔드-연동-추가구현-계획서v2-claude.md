# 006. 백엔드 연동 추가 구현 계획서 v2

> **문서 버전**: 006-v2
> **작성일자**: 2025-11-28
> **작성자**: Claude (Claude/Codex/Gemini 종합)
> **목적**: Swagger API 명세 대비 프론트엔드 미구현/미완성 기능을 정리하고, 체계적인 구현 계획을 수립한다.

---

## 1. 현황 분석 종합

### 1.1 API 엔드포인트 구현 현황

#### 사용자 API (USER)
| 엔드포인트 | HTTP | 구현 상태 | 사용처 | 비고 |
|-----------|------|----------|--------|------|
| `/api/users/me` | GET | ✅ 완료 | Login, Settings, OAuth2Redirect | 사용자 정보 조회 |
| `/api/users/me` | PUT | ✅ 완료 | Onboarding4, Settings | 프로필/테마 수정 |
| `/api/users/logout` | POST | ✅ 완료 | Sidebar, Settings | 로그아웃 |
| `/api/users/me/withdraw` | DELETE | ✅ 완료 | Settings | 회원 탈퇴 (005에서 구현) |
| `/api/users/me/deactivate` | PUT | ✅ 완료 | Settings | 계정 비활성화 (005에서 구현) |

#### AI 채팅 API (EUME_CHAT)
| 엔드포인트 | HTTP | 구현 상태 | 사용처 | 비고 |
|-----------|------|----------|--------|------|
| `/api/eume-chats` | POST | ✅ 완료 | Home | 채팅방 생성 (201/409 분기) |
| `/api/eume-chats/me` | GET | ✅ 완료 | Home | 내 채팅방 정보 조회 |
| `/api/eume-chats/{id}/contents` | POST | ✅ 완료 | Home | 메시지 전송 |
| `/api/eume-chats/{id}/contents` | GET | ⚠️ 미흡 | Home | **과거 대화 내역 로딩 미구현** |

#### 일반 채팅 API (USER_CHAT) - 전체 미구현
| 엔드포인트 | HTTP | 구현 상태 | 필요 사용처 | 비고 |
|-----------|------|----------|-------------|------|
| `/api/user-chats` | GET | ❌ 미구현 | Sidebar, Home | 채팅방 목록 조회 |
| `/api/user-chats` | POST | ❌ 미구현 | Sidebar, Home | 새 채팅방 생성 |
| `/api/user-chats/{id}/contents` | GET | ❌ 미구현 | Home | 대화 내용 조회 |
| `/api/user-chats/{id}/contents` | POST | ❌ 미구현 | Home | 메시지 전송 |

#### 관리자 API (ADMIN)
| 엔드포인트 | HTTP | 구현 상태 | 사용처 | 비고 |
|-----------|------|----------|--------|------|
| `/api/admin/login` | POST | ✅ 완료 | Login | 관리자 로그인 |
| `/api/admin/logout` | POST | ✅ 완료 | AdminLayout | 관리자 로그아웃 |
| `/api/admin/register` | POST | ✅ 완료 | Login | 관리자 회원가입 |
| `/api/admin/orgs` | GET | ✅ 완료 | Login | 복지기관 목록 (무인증) |
| `/api/admin/users` | GET | ✅ 완료 | Users | 이용자 목록 조회 |
| `/api/admin/users/{id}` | GET | ✅ 완료 | Users | 이용자 상세 조회 |
| `/api/admin/users/{id}/status` | PUT | ❌ 미구현 | Users | **이용자 상태 변경** |
| `/api/admin/users/{id}/emotions` | GET | ❌ 미구현 | EmotionMonitor | **이용자 감정 데이터** |
| `/api/admin/users/export` | GET | ✅ 완료 | Users | Excel 내보내기 (Blob) |
| `/api/admin/reports/summary` | GET | ✅ 완료 | Dashboard | 리포트 요약 통계 |
| `/api/admin/reports/export` | GET | ✅ 완료 | Dashboard | 리포트 다운로드 (Blob) |

---

### 1.2 페이지별 구현 현황

#### 사용자 페이지
| 페이지 | 파일 | 상태 | 세부 사항 |
|--------|------|------|----------|
| 로그인 | `Login.jsx` | ✅ 완료 | OAuth2 + 쿠키 인증, 상태 동기화 |
| 온보딩 | `Onboarding1-4.jsx` | ⚠️ 부분 | 수집 정보(생년/성별/전화) 백엔드 미전달 가능성 |
| 홈 (채팅) | `Home.jsx` | ⚠️ 부분 | EUME_CHAT 연동됨, 과거 내역 로딩 미흡, USER_CHAT 미구현 |
| 설정 | `Settings.jsx` | ✅ 완료 | 테마/로그아웃/탈퇴/비활성화 모두 구현 |

#### 관리자 페이지
| 페이지 | 파일 | 상태 | 세부 사항 |
|--------|------|------|----------|
| 로그인 | `Login.jsx` | ✅ 완료 | 로그인/회원가입/기관선택 |
| 대시보드 | `Dashboard.jsx` | ✅ 완료 | 리포트 요약/다운로드 API 연동 |
| 이용자 관리 | `Users.jsx` | ⚠️ 부분 | 목록/상세/Excel 연동됨, 상태변경 미구현 |
| 대화 분석 | `Conversation.jsx` | ❌ Mock | **전체 하드코딩 데이터** |
| 감정 모니터 | `EmotionMonitor.jsx` | ❌ Mock | **전체 하드코딩 데이터** |
| 긴급 상황 | `Emergency.jsx` | ❌ Mock | **전체 가짜 실시간 데이터** |
| 리포트 | `Reports.jsx` | ❓ 확인필요 | API 명세 불분명 |
| 프로필 | `Profile.jsx` | ✅ 완료 | 관리자 프로필 정보 |

---

### 1.3 기술 부채 현황

| 항목 | 현재 상태 | 문제점 |
|------|----------|--------|
| Blob 응답 처리 | `axiosInstance` 인터셉터가 `response.data` 반환 | Content-Type 손실로 XLSX 인식 실패 가능 |
| chatListId 관리 | 컴포넌트 상태에만 저장 | 새로고침 시 유실, 재사용 불가 |
| 에러 처리 | 페이지별 개별 처리 | 일관성 부족, 재시도 로직 미흡 |
| 온보딩 데이터 | localStorage 임시 저장 | 일부 필드 백엔드 미전달 가능성 |
| 실시간 기능 | setInterval Mock | 실제 WebSocket/SSE 미구현 |

---

## 2. 구현 계획

### 2.1 우선순위 1: 핵심 기능 보완

#### [P1-1] EUME_CHAT 과거 대화 내역 로딩

**현재 상태:**
- 채팅방 생성/메시지 전송은 구현됨
- `GET /api/eume-chats/{id}/contents`로 과거 대화 불러오기 미구현
- 새로고침 시 이전 대화 내용 사라짐

**구현 내용:**
1. `Home.jsx`의 `loadExistingChat` 함수에서 채팅방 ID 획득 후 과거 메시지 조회
2. `GET /api/eume-chats/{chatListId}/contents` 호출
3. 응답 메시지를 `messagesByRoom` 상태에 초기값으로 설정
4. 로딩 상태 표시 (스켈레톤 또는 스피너)
5. chatListId를 localStorage에 캐싱하여 재사용

**영향 파일:** `src/user/pages/Home.jsx`
**예상 작업량:** 낮음 (0.5일)

---

#### [P1-2] USER_CHAT 다중 채팅방 기능 (신규)

**현재 상태:**
- `config.js`에 API 정의되어 있으나 전혀 사용되지 않음
- Sidebar의 pinnedRooms가 하드코딩
- "새 채팅", "정책 정보", "이음이 톡" 버튼은 모두 EUME_CHAT 사용

**구현 내용:**
1. **채팅방 목록 조회**: `GET /api/user-chats` → Sidebar에 실제 채팅 히스토리 표시
2. **새 채팅방 생성**: `POST /api/user-chats` → "새 채팅" 버튼 연동
3. **대화 내용 조회**: `GET /api/user-chats/{id}/contents` → 채팅방 전환 시 로드
4. **메시지 전송**: `POST /api/user-chats/{id}/contents` → 메시지 송신
5. **상태 관리**: EUME_CHAT과 USER_CHAT 구분하여 관리
6. **채팅 유형 분기**: pinnedRooms 유형에 따라 다른 API 호출

**UI 변경:**
- Sidebar에 AI 채팅 / 일반 채팅 구분 탭 또는 섹션
- 채팅 목록 최신순 정렬, 검색/필터 기능

**영향 파일:**
- `src/user/components/Sidebar.jsx`
- `src/user/pages/Home.jsx`

**예상 작업량:** 높음 (3-4일)

---

### 2.2 우선순위 2: 관리자 핵심 기능

#### [P2-1] 이용자 상태 변경 기능

**현재 상태:**
- `API_ENDPOINTS.ADMIN.USER_STATUS` 정의됨
- Users.jsx에서 미사용

**구현 내용:**
1. 이용자 상세 모달에 상태 변경 버튼 추가
2. `PUT /api/admin/users/{id}/status` 호출
3. 변경 사유 입력 (필요시)
4. 성공/실패 피드백 표시
5. 목록 자동 갱신

**영향 파일:** `src/admin/pages/Users.jsx`
**예상 작업량:** 낮음 (0.5일)

---

#### [P2-2] 감정 모니터링 API 연동

**현재 상태:**
- EmotionMonitor.jsx 전체가 하드코딩 Mock 데이터
- emotionStats, emotionDistribution, userEmotions 모두 가짜

**구현 내용:**
1. **개별 감정 조회**: `GET /api/admin/users/{id}/emotions` 연동
2. **전체 통계 집계**:
   - 백엔드에 전체 감정 통계 API 존재 여부 확인 필요
   - 없으면 프론트에서 개별 조회 후 집계 또는 API 추가 요청
3. **감정 분포 차트**: 실데이터 기반 렌더링
4. **이용자별 현황 테이블**: 실데이터 연동
5. **기간 필터**: 오늘/7일/30일/3개월 기간별 조회

**백엔드 확인/요청 필요:**
- 전체 감정 통계 집계 API (`GET /api/admin/emotions/summary` 등)
- `GET /api/admin/users`에 최근 감정 상태 포함 여부

**영향 파일:** `src/admin/pages/EmotionMonitor.jsx`
**예상 작업량:** 중간 (2-3일)

---

#### [P2-3] 대화 분석 페이지 API 연동

**현재 상태:**
- Conversation.jsx 전체가 하드코딩 Mock 데이터
- conversationStats, conversations 배열 모두 가짜
- 감정 분석, 키워드 추출 등 복잡한 구조

**구현 내용:**
1. **대화 목록 조회**: 관리자용 전체 대화 API 연동
2. **대화 상세**: 개별 대화 내용 + 분석 결과
3. **통계 표시**: 총 대화 수, 평균 메시지 수, 활성 이용자
4. **감정 분석**: 대화별 감정 분류 결과
5. **키워드 추출**: 주요 키워드/주제 표시
6. **필터/검색**: 이용자명, 주제, 기간, 감정별 필터

**백엔드 확인/요청 필요:**
- 관리자용 대화 목록 API (`GET /api/admin/conversations`)
- 대화 분석 결과 API (감정/키워드)
- 대화 통계 집계 API

**영향 파일:** `src/admin/pages/Conversation.jsx`
**예상 작업량:** 높음 (4-5일)

---

#### [P2-4] 긴급 상황 모니터링 API 연동

**현재 상태:**
- Emergency.jsx 전체가 Mock 데이터
- setInterval로 가짜 실시간 업데이트 시뮬레이션
- 긴급 알림, 활성 사용자 모두 랜덤 생성

**구현 내용:**
1. **긴급 알림 목록**: 실제 긴급 상황 API 연동
2. **상태 변경**: 신규/처리중/해결완료 상태 변경 API
3. **활성 사용자**: 현재 서비스 이용 중인 사용자 목록
4. **실시간 업데이트**:
   - WebSocket 또는 SSE 연동 (백엔드 지원 필요)
   - 또는 Polling 방식 (30초~1분 주기)
5. **알림 기능**: 긴급 상황 발생 시 관리자 알림

**백엔드 확인/요청 필요:**
- 긴급 상황 관련 API 전체 스펙
- 실시간 데이터 전송 방식 (WebSocket/SSE/Polling)
- 알림 발송 API

**영향 파일:** `src/admin/pages/Emergency.jsx`
**예상 작업량:** 높음 (5-7일, 실시간 기능 포함)

---

### 2.3 우선순위 3: 기술 부채 해결

#### [P3-1] Blob 응답 전용 Axios 인스턴스

**현재 상태:**
- `axiosInstance` 인터셉터가 모든 응답에서 `response.data` 반환
- Blob 다운로드 시 Content-Type 정보 손실
- Excel/PDF 파일 인식 실패 가능

**구현 내용:**
1. `axiosBlob` 인스턴스 신규 생성
2. `responseType: 'blob'` 기본 설정
3. 인터셉터 없이 전체 response 반환
4. 기존 다운로드 로직 `axiosBlob` 사용으로 변경

```javascript
// src/shared/api/axiosBlob.js
const axiosBlob = axios.create({
  baseURL: JAVA_URL,
  timeout: 60000, // 다운로드용 긴 타임아웃
  withCredentials: true,
  responseType: 'blob',
});
```

**영향 파일:**
- `src/shared/api/axiosBlob.js` (신규)
- `src/admin/pages/Users.jsx`
- `src/admin/pages/Dashboard.jsx`

**예상 작업량:** 낮음 (0.5일)

---

#### [P3-2] 에러 처리 일관성 개선

**현재 상태:**
- 페이지별 개별 에러 처리
- 401 리다이렉트만 공통 처리
- 재시도 로직 없음

**구현 내용:**
1. **공통 에러 훅** 또는 유틸 함수 작성
2. **에러 유형별 처리**:
   - 401: 로그인 페이지 리다이렉트 (기존 유지)
   - 403: 권한 없음 메시지
   - 404: 리소스 없음 메시지
   - 4xx: 사용자 입력 오류 메시지
   - 5xx: 서버 오류 + 재시도 안내
3. **재시도 로직**: 5xx 에러 시 자동 재시도 (최대 3회)
4. **네트워크 오류**: 오프라인 감지 및 알림

**영향 파일:**
- `src/shared/api/axios.js`
- `src/shared/hooks/useApiError.js` (신규)

**예상 작업량:** 중간 (1-2일)

---

#### [P3-3] 상태/키 관리 정리

**현재 상태:**
- STORAGE_KEYS 상수 사용 중이나 일부 누락
- chatListId 등 세션 데이터 관리 불명확
- 온보딩 임시 데이터 정리 시점 불명확

**구현 내용:**
1. **STORAGE_KEYS 확장**: chatListId, lastChatType 등 추가
2. **세션 데이터 관리**: 로그인/로그아웃 시 정리 로직 명확화
3. **온보딩 임시 데이터**: 온보딩 완료 또는 취소 시 확실히 정리
4. **캐시 전략**: 언제 저장하고 언제 삭제할지 명문화

**영향 파일:**
- `src/shared/constants/storage.js`
- 로그인/로그아웃 관련 컴포넌트들

**예상 작업량:** 낮음 (0.5일)

---

### 2.4 우선순위 4: 추가 개선

#### [P4-1] 온보딩 데이터 백엔드 전달 검증

**현재 상태:**
- Onboarding3에서 이메일/이름/생년/성별/전화 수집
- Onboarding4에서 PUT `/api/users/me` 호출
- 모든 필드가 정확히 전달되는지 확인 필요

**구현 내용:**
1. 백엔드 API 스키마와 프론트엔드 전송 데이터 매핑 검증
2. 누락된 필드 있으면 추가
3. 전송 실패 시 재시도 로직

**영향 파일:** `src/user/pages/Onboarding4.jsx`
**예상 작업량:** 낮음 (0.5일)

---

#### [P4-2] 리포트 페이지 기획 명확화

**현재 상태:**
- Reports.jsx 존재하나 API 연동 상태 불명확
- 정기 리포트 vs 주문형 리포트 기획 불명확

**구현 내용:**
1. 백엔드 팀과 리포트 기능 기획 협의
2. 필요 API 정의 및 요청
3. 확정된 기획에 따라 구현

**영향 파일:** `src/admin/pages/Reports.jsx`
**예상 작업량:** 미정 (기획 협의 후 결정)

---

## 3. 백엔드 확인/요청 필요 사항

### 3.1 API 존재 여부 확인
| 기능 | 필요 API | 비고 |
|------|---------|------|
| 대화 분석 | `GET /api/admin/conversations` | 전체 대화 목록 |
| 대화 분석 | `GET /api/admin/conversations/{id}` | 대화 상세 + 분석 |
| 대화 통계 | `GET /api/admin/conversations/stats` | 집계 데이터 |
| 감정 통계 | `GET /api/admin/emotions/summary` | 전체 감정 집계 |
| 긴급 상황 | `GET /api/admin/emergencies` | 긴급 알림 목록 |
| 긴급 상황 | `PUT /api/admin/emergencies/{id}` | 상태 변경 |
| 활성 사용자 | `GET /api/admin/users/active` | 실시간 접속자 |
| 실시간 | WebSocket/SSE 엔드포인트 | 실시간 데이터 |

### 3.2 응답 형식 확인
| API | 확인 필요 사항 |
|-----|--------------|
| `GET /api/admin/users/{id}/emotions` | 응답 데이터 구조 |
| `PUT /api/admin/users/{id}/status` | 요청/응답 형식 |
| `GET /api/user-chats` | 채팅방 목록 응답 구조 |
| `GET /api/user-chats/{id}/contents` | 메시지 목록 응답 구조 |
| `GET /api/admin/users` | 최근 감정 상태 포함 여부 |

---

## 4. 구현 순서 제안

### Phase 1: 사용자 채팅 핵심 (1주차)
1. **[P1-1]** EUME_CHAT 과거 대화 내역 로딩 (0.5일)
2. **[P3-1]** Blob 응답 전용 Axios (0.5일)
3. **[P1-2]** USER_CHAT 다중 채팅방 기능 (3-4일)

### Phase 2: 관리자 기본 기능 (2주차)
4. **[P2-1]** 이용자 상태 변경 (0.5일)
5. **[P2-2]** 감정 모니터링 API 연동 (2-3일)
6. **[P3-3]** 상태/키 관리 정리 (0.5일)

### Phase 3: 관리자 분석 기능 (3주차)
7. **[P2-3]** 대화 분석 페이지 API 연동 (4-5일)
8. **[P3-2]** 에러 처리 일관성 개선 (1-2일)

### Phase 4: 실시간 및 마무리 (4주차)
9. **[P2-4]** 긴급 상황 모니터링 API 연동 (5-7일)
10. **[P4-1]** 온보딩 데이터 검증 (0.5일)
11. **[P4-2]** 리포트 페이지 (기획 협의 후)

---

## 5. 기술적 고려사항

### 5.1 인증 방식
- HttpOnly 쿠키 기반 인증 (`withCredentials: true`)
- 401 에러 시 로그인 페이지 리다이렉트 (axios 인터셉터)
- 로그인/OAuth 페이지에서는 리다이렉트 예외 처리 완료

### 5.2 실시간 기능 구현 옵션
| 방식 | 장점 | 단점 | 적합한 경우 |
|------|-----|------|-----------|
| WebSocket | 양방향, 실시간 | 구현 복잡, 연결 관리 필요 | 채팅, 즉시 알림 |
| SSE | 단순, 자동 재연결 | 단방향 | 서버→클라이언트 알림 |
| Polling | 가장 단순 | 서버 부하, 지연 | MVP, 간단한 업데이트 |

### 5.3 상태 관리 전략
- 현재: React 컴포넌트 로컬 상태 + localStorage
- 권장: 복잡한 상태 공유 시 Context API 활용
- chatListId, 사용자 정보 등 전역 상태로 관리 검토

### 5.4 코드 구조 개선
```
src/shared/
├── api/
│   ├── axios.js       # 기본 인스턴스
│   ├── axiosBlob.js   # Blob 다운로드용 (신규)
│   └── config.js      # 엔드포인트 정의
├── hooks/
│   ├── useApiError.js # 에러 처리 훅 (신규)
│   └── useAuth.js     # 인증 상태 훅 (선택)
└── constants/
    └── storage.js     # STORAGE_KEYS (확장)
```

---

## 6. 검증 체크리스트

### 채팅 기능
- [ ] EUME_CHAT: 새로고침 후 과거 대화 내역 표시
- [ ] EUME_CHAT: 메시지 전송 실패 시 재시도 가능
- [ ] USER_CHAT: 채팅방 목록 정상 조회
- [ ] USER_CHAT: 새 채팅방 생성 및 진입
- [ ] USER_CHAT: 채팅방 전환 시 대화 내용 유지

### 관리자 기능
- [ ] 이용자 상태 변경 후 목록 반영
- [ ] 감정 모니터링 실데이터 표시
- [ ] 대화 분석 실데이터 표시
- [ ] 긴급 상황 실시간 업데이트

### 다운로드
- [ ] Excel 파일 정상 다운로드 및 열기
- [ ] PDF 파일 정상 다운로드 및 열기

### 에러 처리
- [ ] 401 에러 시 로그인 리다이렉트
- [ ] 네트워크 오류 시 사용자 알림
- [ ] 서버 오류 시 재시도 안내

---

## 7. 참고 파일

### API 관련
- `src/shared/api/config.js` - API 엔드포인트 정의
- `src/shared/api/axios.js` - Axios 인스턴스 및 인터셉터

### 사용자 페이지
- `src/user/pages/Home.jsx` - 채팅 메인
- `src/user/components/Sidebar.jsx` - 사이드바
- `src/user/pages/Settings.jsx` - 설정
- `src/user/pages/Onboarding1-4.jsx` - 온보딩

### 관리자 페이지
- `src/admin/pages/Dashboard.jsx` - 대시보드
- `src/admin/pages/Users.jsx` - 이용자 관리
- `src/admin/pages/Conversation.jsx` - 대화 분석 (Mock)
- `src/admin/pages/EmotionMonitor.jsx` - 감정 모니터 (Mock)
- `src/admin/pages/Emergency.jsx` - 긴급 상황 (Mock)
- `src/admin/pages/Reports.jsx` - 리포트

---

## 8. 변경 이력

| 날짜 | 버전 | 작성자 | 내용 |
|------|------|--------|------|
| 2025-11-28 | 1.0 | Claude | 초안 작성 |
| 2025-11-28 | 2.0 | Claude | Claude/Codex/Gemini 계획서 종합, 기술 부채 상세화, 체크리스트 추가 |
