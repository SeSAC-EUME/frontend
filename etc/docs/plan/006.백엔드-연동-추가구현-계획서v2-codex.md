# 006. 백엔드 연동 추가구현 계획서 v2 (Codex)
<!-- Encoding: UTF-8 (no BOM), Line Ending: CRLF -->

> **문서 버전**: 006-v2
> **작성일자**: 2025-11-28
> **작성자**: Codex
> **참조 문서**: 006.백엔드-연동-추가구현-계획서-(claude/gemini/codex)
> **목적**: Swagger(EumeChat/UserChat 등) 기준으로 프론트-백엔드 연동 상태를 통합 점검하고, 미구현·보완 과제를 정리해 단계별 실행 계획을 수립한다.

---

## 1. 통합 현황 요약 (Swagger 대비)
- 공통
  - 쿠키 기반 인증 전환 완료(`axiosInstance` withCredentials). STORAGE_KEYS 통일. 응답 인터셉터가 `response.data`만 반환 → Blob MIME 손실 가능.
- 사용자 도메인
  - 로그인/OAuth/온보딩: GET `/api/users/me` 연동, 온보딩4에서 PUT `/api/users/me`로 테마·닉네임 저장. 온보딩3 수집(이메일/생년/성별/전화) 미전달.
  - 홈(Home.jsx): EumeChat 생성(POST `/api/eume-chats`)·전송(POST `/api/eume-chats/{id}/contents`) 일부 구현. 기존 대화 로드 GET `/api/eume-chats/me` 호출만 하고 UI 반영 없음. UserChat 전 API 미사용.
  - 설정(Settings.jsx): 테마 동기화(PUT `/api/users/me`), 로그아웃(POST `/api/users/logout`). 탈퇴(`/withdraw`), 휴면(`/deactivate`) 미노출. Splash/Sidebar 등 일부 임시 키 클린업 누락.
- 관리자 도메인
  - 인증: 로그인/회원가입/로그아웃, 기관 목록 연동 완료. 세션 검증은 AdminLayout에서 수행.
  - 대시보드: GET `/api/admin/reports/summary`, 보고서 다운로드 GET `/api/admin/reports/export` 호출 추가(Blob 타입 손실 위험, 0값 기본치로 덮임 문제 있음).
  - 이용자 관리: GET `/api/admin/users`, `/users/{id}` 연동. 상태 변경(`/status`), 감정(`/emotions`) 미사용. Excel 내보내기 호출 추가(Blob 처리 동일 문제).
  - 기타 페이지(Conversation/EmotionMonitor/Emergency/Reports): 목업 상태, Swagger 명세 기반 연동 미착수.

---

## 2. 미구현/보완 과제 (정리)
- **채팅**
  - EumeChat: 201/409 분기 후 `chatListId` 캐시/재사용 미흡, 기존 대화 GET 결과 UI 미반영, 전송 실패/재시도 UX 없음.
  - UserChat: 목록/생성/대화 조회/전송 전부 미구현(UI·상태·API 연동 없음).
- **사용자 계정 플로우**
  - 온보딩3 입력 필드가 백엔드로 전달되지 않음(온보딩4 PUT payload 부족).
  - 탈퇴(`/withdraw`), 휴면(`/deactivate`) UI/처리 미구현.
  - OAuth 임시 키/설정 키 클린업 누락 경로 존재(Splash/Sidebar/Settings).
- **파일 다운로드**
  - `axiosInstance` 인터셉터가 Blob Content-Type 제거 → 보고서/Excel 인식 실패 가능. Blob 생성 시 MIME 미지정.
- **관리자 기능**
  - 사용자 상세 모달이 폴백 데이터만 사용; 상태 변경(`/status`), 감정 이력(`/emotions`) 미연동.
  - 대화/감정/긴급/보고서 페이지는 Swagger 명세 확인 후 API 연결 필요(미제공 시 목업 명시 필요).
- **데이터 품질/에러 처리**
  - 통계/숫자값 0 처리 시 기본값 덮어쓰기(Dashboard). 에러 UX 통일 부족(채팅/다운로드 등).

---

## 3. 실행 계획 (우선순위·페이징)
### Phase 1: 공통 기반 정비 (빠른 적용)
1) Blob/파일 다운로드 전용 axios 인스턴스 또는 인터셉터 우회 경로 추가; XLSX MIME 지정.
2) 에러 처리 공통화: 401 리다이렉트, 4xx 사용자 메시지, 5xx 재시도 가이드. 채팅/다운로드에도 적용.
3) STORAGE_KEYS 클린업 표준화: 로그아웃/스플래시/온보딩 흐름에서 OAuth 임시 키·설정 키 삭제.

### Phase 2: 채팅 도메인
4) EumeChat 보완
   - `chatListId` 저장/재사용(로컬 상태+스토리지), 201/409 분기 캐시.
   - GET `/api/eume-chats/me` + `/contents` 결과를 `messagesByRoom`·히스토리에 반영, 스크롤/페이징 설계.
   - 전송 실패/재시도 UX 추가.
5) UserChat 신규 연동
   - 목록(GET `/api/user-chats`) → 좌측 리스트/검색/정렬.
   - 생성(POST `/api/user-chats`) → 새 방 진입.
   - 대화 조회/전송(GET/POST `/api/user-chats/{id}/contents`).
   - EumeChat과 메시지 상태 모델 공유 또는 분리 결정.

### Phase 3: 사용자 계정 플로우
6) 온보딩4 payload 확장: 온보딩3 저장 필드(email/userName/birthDate/gender/phone/providerId 등) 포함, 백엔드 스키마 매핑 확인.
7) 탈퇴/휴면 UI 추가(Settings): `/withdraw`, `/deactivate` 연동, 성공 시 세션·스토리지 정리 및 로그인 리다이렉트.

### Phase 4: 관리자 기능 강화
8) 이용자 상세/상태/감정 연동: GET `/users/{id}` 매핑, `/status` 상태 변경, `/emotions` 이력 노출. 실패 시 안내 메시지.
9) 대시보드/엑셀 다운로드 개선: 0값 허용(nullish 병합), Blob MIME 처리, 실패 알림.
10) 기타 페이지(Conversation/EmotionMonitor/Emergency/Reports): Swagger로 실제 제공 API 확인 → 있으면 연동, 없으면 목업/비활성 명시.

---

## 4. 전제·검증 메모
- Swagger 기준 미확인 엔드포인트(Admin 대화/감정/긴급/보고서 상세)는 백엔드 스펙을 재확인 후 착수.
- 채팅 검증: 신규/기존 방 모두 로드, 메시지 송수신·재시도, 방 전환 시 상태 유지.
- 계정 검증: 온보딩 데이터 백엔드 반영, 탈퇴/휴면 시 재로그인 요구 및 로컬 키 정리.
- 다운로드 검증: 보고서/Excel 파일이 정상 열리고 MIME/크기 일치.
- 관리자 검증: 상세/상태/감정 API 응답이 UI와 일치, 실패 시 사용자 안내 표시.

---

## 5. 산출물/작업 경로
- 계획서: `etc/docs/plan/006.백엔드-연동-추가구현-계획서v2-codex.md`
- 참조: Swagger 명세, `src/shared/api/config.js`, `src/user/pages/Home.jsx`, `src/admin/pages/Users.jsx`, `src/admin/pages/Dashboard.jsx`, `src/admin/pages/Conversation.jsx`, `src/admin/pages/EmotionMonitor.jsx`, `src/admin/pages/Emergency.jsx`.
