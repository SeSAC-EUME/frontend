# 백엔드-프론트엔드 연동 계획서

## 1. 개요

### 1.1 목적
Spring Boot 백엔드(8080 포트)와 React 프론트엔드(3000 포트) 간의 API 연동을 체계적으로 구현하기 위한 계획서입니다.

### 1.2 현재 상태
- **백엔드**: `http://localhost:8080` (Swagger 문서: `/swagger-ui/index.html`)
- **프론트엔드**: `http://localhost:3000` (Vite 개발 서버)
- **연동 상태**: 부분적 구현 (로그인, OAuth2 일부만 연동됨)

---

## 2. 현재 프론트엔드 API 구조 분석

### 2.1 기존 API 설정 (`src/shared/api/config.js`)
```javascript
// 현재 정의된 엔드포인트 (수정 필요)
ADMIN: {
  LOGIN: `${JAVA_URL}admin/login`,        // 실제: /api/admin/login
  REGISTER: `${JAVA_URL}admin/register`,  // 실제: /api/admin/register
  CHANGE_PASSWORD: `${JAVA_URL}admin/change-password`,  // [검토] 백엔드에 없음!
},
USER: {
  LOGOUT: `${JAVA_URL}user/logout`,       // 실제: /api/users/logout
  REGISTER: `${JAVA_URL}user/register`,   // [검토] 백엔드에 없음! (OAuth2 기반)
  UPDATE: `${JAVA_URL}user/update`,       // 실제: PUT /api/users/me
  WITHDRAW: `${JAVA_URL}user/withdraw`,   // 실제: /api/users/me/withdraw
}
```

### 2.2 현재 연동된 기능
| 파일 | API 호출 | 상태 | [검토] 문제점 |
|------|----------|------|--------------|
| `admin/pages/Login.jsx` | `axiosInstance.post(API_ENDPOINTS.ADMIN.LOGIN)` | 수정 필요 | 경로 불일치 + **요청 형식 불일치** |
| `user/pages/OAuth2Redirect.jsx` | `fetch('/api/users/me')` | 경로 정상 | fetch 대신 axiosInstance 사용 권장 |
| `user/pages/Onboarding4.jsx` | `axiosInstance.post(API_ENDPOINTS.USER.REGISTER)` | **심각한 문제** | 백엔드에 해당 API 없음 |

### 2.3 문제점
1. **경로 불일치**: 현재 config.js는 `/admin/login` 형태, 백엔드는 `/api/admin/login` 형태
2. **미구현 API 다수**: 채팅, 감정분석, 보고서 등 핵심 API 미연동
3. **인증 방식 혼재**: 일부는 axiosInstance, 일부는 fetch 직접 사용
4. **[검토 추가] 요청/응답 형식 불일치**: 관리자 로그인 요청 필드명이 다름
5. **[검토 추가] 사용자 회원가입 API 누락**: 백엔드에서 OAuth2만 지원, `/user/register` 없음
6. **[검토 추가] 테마 값 불일치**: 프론트엔드 테마와 백엔드 테마 enum이 다름

### 2.4 [검토 추가] 관리자 로그인 요청 형식 불일치 상세
```javascript
// 현재 프론트엔드 코드 (admin/pages/Login.jsx:76-80)
{
  loginId: formData.username,      // 잘못됨 → adminLoginId
  password: formData.password,     // 잘못됨 → adminPw
  loginType: 'LOCAL'               // 백엔드에서 요구하지 않음
}

// 백엔드 AdminLoginRequest (Swagger 기준)
{
  sigunguId: number,    // 필수! (누락됨)
  adminLoginId: string, // 필수
  adminPw: string       // 필수
}
```

### 2.5 [검토 추가] 테마 값 불일치
| 프론트엔드 | 백엔드 |
|-----------|--------|
| 'ocean' | 'DEFAULT' |
| 'sunset' | 'DARK' |
| 'forest' | 'LIGHT' |
| 'lavender' | - |
| 'rose' | - |

**해결 방안**: 테마 매핑 함수 필요 또는 백엔드와 협의하여 테마 값 통일

---

## 3. 백엔드 API 구조 (Swagger 기준)

### 3.1 API 태그 분류
| 태그 | 설명 | 인증 필요 |
|------|------|----------|
| Admin | 관리자 전용 API | O (orgs 제외) |
| User | 사용자 관련 API | O |
| EumeChat | Eume AI 채팅 API | O |
| UserChat | 다중 채팅 API | O |
| [검토 추가] health-check | 헬스체크 | X |

### 3.2 전체 엔드포인트 목록

#### User API
| 메소드 | 경로 | 설명 |
|--------|------|------|
| GET | `/api/users/me` | 나의 정보 조회 |
| PUT | `/api/users/me` | 나의 정보 수정 |
| POST | `/api/users/me/withdraw` | 계정 탈퇴 |
| POST | `/api/users/me/deactivate` | 계정 비활성화 |
| POST | `/api/users/logout` | 로그아웃 |

> **[검토 추가] 참고**: 사용자 회원가입(/register) API는 없음. OAuth2 기반 자동 가입.

#### EumeChat API (메인 AI 채팅)
| 메소드 | 경로 | 설명 |
|--------|------|------|
| POST | `/api/eume-chats` | 채팅방 생성 (사용자당 1개) |
| GET | `/api/eume-chats/me` | 내 채팅방 조회 |
| GET | `/api/eume-chats/{chatListId}/contents` | 대화 내용 조회 (페이지네이션) |
| POST | `/api/eume-chats/{chatListId}/contents` | 메시지 발송 (AI 응답 포함) |

#### UserChat API (다중 채팅)
| 메소드 | 경로 | 설명 |
|--------|------|------|
| GET | `/api/user-chats` | 채팅방 목록 조회 |
| POST | `/api/user-chats` | 채팅방 생성 |
| GET | `/api/user-chats/{chatListId}/contents` | 메시지 목록 조회 |
| POST | `/api/user-chats/{chatListId}/contents` | 메시지 발송 |

#### Admin API
| 메소드 | 경로 | 설명 |
|--------|------|------|
| POST | `/api/admin/login` | 관리자 로그인 |
| POST | `/api/admin/logout` | 관리자 로그아웃 |
| POST | `/api/admin/register` | 관리자 회원가입 |
| GET | `/api/admin/orgs` | 소속 기관 목록 (인증 불필요) |
| GET | `/api/admin/users` | 사용자 목록 조회 |
| GET | `/api/admin/users/{userId}` | 사용자 상세 조회 |
| PATCH | `/api/admin/users/{userId}/status` | 사용자 상태 변경 |
| GET | `/api/admin/users/{userId}/emotions` | 사용자 감정 기록 조회 |
| GET | `/api/admin/users/export` | 이용자 데이터 Excel 내보내기 |
| GET | `/api/admin/reports/summary` | 보고서 요약 조회 |
| GET | `/api/admin/reports/export` | 보고서 Excel 다운로드 |

#### [검토 추가] 기타
| 메소드 | 경로 | 설명 |
|--------|------|------|
| GET | `/health-check` | 서버 상태 확인 |

---

## 4. 연동 작업 계획

### 4.1 Phase 1: API 설정 리팩토링 (우선순위: **긴급**)

#### 작업 1.1: `src/shared/api/config.js` 수정
```javascript
// 수정된 API 엔드포인트 구조
export const API_ENDPOINTS = {
  // [검토 추가] 공통
  HEALTH_CHECK: `${JAVA_URL}health-check`,

  // 사용자 API
  USER: {
    ME: `${JAVA_URL}api/users/me`,
    LOGOUT: `${JAVA_URL}api/users/logout`,
    WITHDRAW: `${JAVA_URL}api/users/me/withdraw`,
    DEACTIVATE: `${JAVA_URL}api/users/me/deactivate`,
    // [검토] REGISTER 삭제 - OAuth2 기반으로 별도 회원가입 없음
  },

  // Eume AI 채팅 API
  EUME_CHAT: {
    CREATE: `${JAVA_URL}api/eume-chats`,
    ME: `${JAVA_URL}api/eume-chats/me`,
    CONTENTS: (chatListId) => `${JAVA_URL}api/eume-chats/${chatListId}/contents`,
  },

  // 다중 채팅 API
  USER_CHAT: {
    LIST: `${JAVA_URL}api/user-chats`,
    CREATE: `${JAVA_URL}api/user-chats`,
    CONTENTS: (chatListId) => `${JAVA_URL}api/user-chats/${chatListId}/contents`,
  },

  // 관리자 API
  ADMIN: {
    LOGIN: `${JAVA_URL}api/admin/login`,
    LOGOUT: `${JAVA_URL}api/admin/logout`,
    REGISTER: `${JAVA_URL}api/admin/register`,
    ORGS: `${JAVA_URL}api/admin/orgs`,
    USERS: `${JAVA_URL}api/admin/users`,
    USER_DETAIL: (userId) => `${JAVA_URL}api/admin/users/${userId}`,
    USER_STATUS: (userId) => `${JAVA_URL}api/admin/users/${userId}/status`,
    USER_EMOTIONS: (userId) => `${JAVA_URL}api/admin/users/${userId}/emotions`,
    USERS_EXPORT: `${JAVA_URL}api/admin/users/export`,
    REPORTS_SUMMARY: `${JAVA_URL}api/admin/reports/summary`,
    REPORTS_EXPORT: `${JAVA_URL}api/admin/reports/export`,
  },
};
```

#### 작업 1.2: Axios 인스턴스 설정 확인
- `withCredentials: true` 설정 추가 (쿠키 기반 인증)
- 토큰 저장 위치 통일 (`accessToken` vs `eume_user_token`)
- 에러 핸들링 개선

#### [검토 추가] 작업 1.3: 관리자 로그인 요청 형식 수정 (`admin/pages/Login.jsx`)
```javascript
// 수정 전
const result = await axiosInstance.post(API_ENDPOINTS.ADMIN.LOGIN, {
  loginId: formData.username,
  password: formData.password,
  loginType: 'LOCAL'
});

// 수정 후
const result = await axiosInstance.post(API_ENDPOINTS.ADMIN.LOGIN, {
  sigunguId: selectedOrgId,      // 소속 기관 선택 UI 필요
  adminLoginId: formData.username,
  adminPw: formData.password
});
```

#### [검토 추가] 작업 1.4: 온보딩 흐름 재설계
- `Onboarding4.jsx`에서 `USER.REGISTER` 호출 제거
- OAuth2 로그인 시 자동 가입 후 `/api/users/me` PUT으로 추가 정보 업데이트

### 4.2 Phase 2: 사용자 앱 연동 (우선순위: 높음)

#### 작업 2.1: 사용자 인증 흐름 정리
| 페이지 | 연동 작업 |
|--------|----------|
| Login.jsx | OAuth2 소셜 로그인 연동 유지 |
| OAuth2Redirect.jsx | [검토] axiosInstance 사용으로 변경 권장 |
| Settings.jsx | 프로필 조회/수정 API 연동 (`GET/PUT /api/users/me`) |

#### [검토 추가] 작업 2.2: 온보딩 흐름 변경
- [ ] Onboarding4.jsx: 회원가입 API 호출 제거
- [ ] 대신 `/api/users/me` PUT으로 추가 정보 업데이트
- [ ] 테마 값 매핑 함수 추가

#### 작업 2.3: AI 채팅 기능 (Home.jsx)
- [ ] 채팅방 존재 여부 확인 (`GET /api/eume-chats/me`)
- [ ] 채팅방 생성 (`POST /api/eume-chats`)
- [ ] 대화 내용 조회 (`GET /api/eume-chats/{id}/contents`)
- [ ] 메시지 발송 및 AI 응답 수신 (`POST /api/eume-chats/{id}/contents`)

### 4.3 Phase 3: 관리자 앱 연동 (우선순위: 중간)

#### 작업 3.1: 인증 시스템
| 페이지 | 연동 작업 |
|--------|----------|
| Login.jsx | [검토] 로그인 API 경로 수정 + **요청 형식 수정** + 소속기관 목록 연동 |
| (신규) Register.jsx | 회원가입 API 연동 |

#### 작업 3.2: 사용자 관리 (Users.jsx)
- [ ] 사용자 목록 조회 (페이지네이션, 필터링)
- [ ] 사용자 상세 조회
- [ ] 사용자 상태 변경 (ACTIVE/DEACTIVATED)
- [ ] Excel 내보내기

#### 작업 3.3: 감정 모니터링 (EmotionMonitor.jsx)
- [ ] 사용자별 감정 기록 조회
- [ ] 날짜 범위 필터링 (startDate, endDate)

#### 작업 3.4: 보고서 (Reports.jsx)
- [ ] 보고서 요약 조회 (fromDate, toDate 필수)
- [ ] Excel 다운로드

#### 작업 3.5: 대시보드 (Dashboard.jsx)
- [ ] 통계 데이터 연동

### 4.4 Phase 4: 공통 기능 개선 (우선순위: 낮음)

- [ ] API 서비스 레이어 생성 (`src/shared/api/services/`)
- [ ] React Query 또는 SWR 도입 검토
- [ ] 에러 바운더리 및 로딩 상태 통일
- [ ] [검토 추가] 테마 매핑 유틸리티 함수 생성

---

## 5. 데이터 타입 정의

### 5.1 사용자 관련

#### EumeUserProfileResponse
```typescript
interface EumeUserProfileResponse {
  email: string;
  userName: string;
  nickname: string;
  profileImage: string;
  sigungu: {
    sido: string;
    sigungu: string;
  };
  birthDate: string; // date format (YYYY-MM-DD)
  gender: string;
  phone: string;
  lastLoginDate: string; // datetime
  backGroundTheme: 'DEFAULT' | 'DARK' | 'LIGHT';
  createdAt: string;
  updatedAt: string;
}
```

#### EumeUserUpdateRequest
```typescript
interface EumeUserUpdateRequest {
  userName?: string;
  nickName?: string;  // [검토] 주의: nickname이 아닌 nickName (카멜케이스)
  profileImage?: string;
  sigunguId?: number;
  birthDate?: string; // date format
  gender?: string;
  phone?: string;
  backgroundTheme?: 'DEFAULT' | 'DARK' | 'LIGHT';
}
```

### 5.2 채팅 관련

#### EumeChatContentCreateRequest
```typescript
interface EumeChatContentCreateRequest {
  messageContent: string; // required
}
```

#### EumeChatContentCreateResponse
```typescript
interface EumeChatContentCreateResponse {
  userMessage: {
    id: number;
    messageType: string;
    messageContent: string;
    createdAt: string;
  };
  eumeMessage: {
    id: number;
    messageType: string;
    messageContent: string;
    createdAt: string;
  };
}
```

#### [검토 추가] UserChatListCreateRequest
```typescript
interface UserChatListCreateRequest {
  roomTitle: string; // required, max 100자
}
```

#### [검토 추가] UserChatContentCreateRequest
```typescript
interface UserChatContentCreateRequest {
  messageContent: string; // required
  messageType: string;    // required
}
```

### 5.3 관리자 관련

#### AdminLoginRequest
```typescript
interface AdminLoginRequest {
  sigunguId: number;    // required - 소속 기관 ID
  adminLoginId: string; // required - 관리자 아이디
  adminPw: string;      // required - 비밀번호
}
```

#### AdminLoginResponse
```typescript
interface AdminLoginResponse {
  id: number;
  adminName: string;
  adminEmail: string;
  lastLoginDate: string;
}
```

#### [검토 추가] AdminRegisterRequest
```typescript
interface AdminRegisterRequest {
  sigunguId: number;    // required
  adminLoginId: string; // required, 4-20자
  adminPw: string;      // required, 8-100자
  adminName: string;    // required
  adminEmail: string;   // required
  adminPhone?: string;
}
```

#### [검토 추가] AdminOrgResponse
```typescript
interface AdminOrgResponse {
  id: number;
  name: string;
}
```

### 5.4 [검토 추가] 페이지네이션 공통 구조

```typescript
interface PaginationResponse<T> {
  // 실제 데이터 (키는 API마다 다름: users, chatRooms, contents, emotions 등)
  [key: string]: T[];
  currentPage: number;
  totalPages: number;
  totalElements: number;
  hasNext: boolean;
  hasPrevious: boolean;
}

// 페이지네이션 요청 파라미터
interface PaginationParams {
  page?: number;  // default: 0
  size?: number;  // default: 20
}
```

### 5.5 [검토 추가] 감정 분석 관련

#### AdminUserEmotionResponse
```typescript
interface AdminUserEmotionResponse {
  id: number;
  depressionScore: number;
  anxietyScore: number;
  stressScore: number;
  emotionScore: number;
  keywords: string[];
  analysisDate: string;
  modelVersion: string;
}
```

### 5.6 [검토 추가] 보고서 관련

#### AdminReportSummaryResponse
```typescript
interface AdminReportSummaryResponse {
  userActivity: {
    totalUsers: number;
    activeUsers: number;
    newUsers: number;
  };
  conversation: {
    totalConversations: number;
    dailyAvgConversations: number;
    totalMessages: number;
  };
  emotion: {
    needAttentionUsers: number;
    avgEmotionScore: number;
    emotionDistribution: Record<string, number>;
  };
  dailyStats: Array<{
    date: string;
    activeUsers: number;
    conversations: number;
    avgEmotionScore: number;
  }>;
}
```

---

## 6. 인증 처리 방식

### 6.1 JWT 토큰 관리
- **저장 위치**: 쿠키 (`sh_access_token`) - HttpOnly 권장
- **요청 시**: `credentials: 'include'` 또는 `withCredentials: true`
- **만료 처리**: 401 응답 시 로그인 페이지로 리다이렉트

### 6.2 사용자 vs 관리자 구분
| 구분 | 토큰 키 | 세션 키 |
|------|---------|---------|
| 사용자 | `eume_user_token` | `user`, `oauth_user` |
| 관리자 | `token` | `eume_admin_user`, `eume_admin_session_expiry` |

### 6.3 [검토 추가] Axios 인스턴스 설정 권장사항
```javascript
const axiosInstance = axios.create({
  baseURL: JAVA_URL,
  timeout: API_CONFIG.timeout,
  headers: API_CONFIG.headers,
  withCredentials: true,  // 쿠키 포함 필수!
});
```

---

## 7. 작업 우선순위 정리

### [검토 수정] 즉시 수행 (긴급)
1. **[긴급] 관리자 로그인 요청 형식 수정** - 현재 로그인 불가능 상태
2. **[긴급] 온보딩 흐름 수정** - USER.REGISTER API 없음
3. API config.js 경로 수정

### 단기 (1주차)
4. 관리자 로그인에 소속기관 선택 UI 추가
5. 사용자 Home 페이지 AI 채팅 연동
6. 테마 값 매핑 함수 구현

### 중기 (2주차)
7. 사용자 Settings 프로필 조회/수정
8. 관리자 Users 페이지 목록/상세
9. 관리자 Dashboard 통계 연동

### 후기 (3주차)
10. 관리자 EmotionMonitor 연동
11. 관리자 Reports 연동
12. Excel 내보내기 기능

---

## 8. 참고 사항

### 8.1 CORS 설정
백엔드에서 프론트엔드 도메인 허용 필요:
```
Access-Control-Allow-Origin: http://localhost:3000
Access-Control-Allow-Credentials: true
```

### 8.2 환경 변수
```env
VITE_API_URL=http://localhost:8080/
```

### 8.3 Swagger 문서 위치
- UI: http://localhost:8080/swagger-ui/index.html
- JSON: http://localhost:8080/v3/api-docs

### 8.4 [검토 추가] 테마 매핑 유틸리티 예시
```javascript
// src/shared/utils/themeMapper.js
const FRONTEND_TO_BACKEND_THEME = {
  'ocean': 'DEFAULT',
  'sunset': 'DARK',
  'forest': 'LIGHT',
  'lavender': 'DEFAULT',  // 백엔드에 없으면 기본값
  'rose': 'DEFAULT',
};

const BACKEND_TO_FRONTEND_THEME = {
  'DEFAULT': 'ocean',
  'DARK': 'sunset',
  'LIGHT': 'forest',
};

export const toBackendTheme = (frontendTheme) =>
  FRONTEND_TO_BACKEND_THEME[frontendTheme] || 'DEFAULT';

export const toFrontendTheme = (backendTheme) =>
  BACKEND_TO_FRONTEND_THEME[backendTheme] || 'ocean';
```

---

## 변경 이력

| 날짜 | 버전 | 작성자 | 내용 |
|------|------|--------|------|
| 2025-11-28 | 1.0 | Claude | 최초 작성 |
| 2025-11-28 | 1.1 | Claude | 검토 후 수정 - 요청 형식 불일치, 누락 API, 테마 불일치 등 추가 |

---

## [검토 추가] 검토 결과 요약

### 발견된 주요 문제점

| # | 문제점 | 심각도 | 해결 방안 |
|---|--------|--------|----------|
| 1 | 관리자 로그인 요청 형식 불일치 | **긴급** | loginId→adminLoginId, password→adminPw, sigunguId 추가 |
| 2 | 사용자 회원가입 API 없음 | **긴급** | Onboarding4.jsx에서 REGISTER 제거, PUT /api/users/me 사용 |
| 3 | 테마 값 불일치 | 높음 | 매핑 함수 구현 또는 백엔드 협의 |
| 4 | 누락된 데이터 타입 | 중간 | UserChat, 페이지네이션, 감정/보고서 타입 추가 |
| 5 | Health Check API 누락 | 낮음 | config.js에 추가 |
| 6 | Axios withCredentials 미설정 | 중간 | axios.js 설정 확인 필요 |

### 권장 조치 사항
1. **즉시**: 관리자 로그인 페이지 요청 형식 수정 (현재 로그인 불가)
2. **즉시**: 온보딩 흐름 재설계 (OAuth2 기반으로 변경)
3. **단기**: 테마 매핑 유틸리티 함수 생성
4. **단기**: Axios 인스턴스에 `withCredentials: true` 추가 확인
