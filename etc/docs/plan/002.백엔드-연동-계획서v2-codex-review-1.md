# 백엔드-연동-계획서 v2 제안 (codex review 1)

## 1. 검토 범위
- 참조 문서: `001.백엔드-연동-계획서.md`, `001.백엔드-연동-계획서-claude-review-1.md`, `001.백엔드-연동-계획서-codex-review-1.md`.
- 참조 코드: `src/shared/api/config.js`, `src/shared/api/axios.js`, 사용자/관리자 주요 페이지.
- 백엔드 기준: Swagger (`/api/...`, HttpOnly 쿠키 + credentials 포함) 가정.

## 2. 핵심 수정안 (우선 적용)
1) **엔드포인트 정합성**: 모든 경로에 `/api/` 프리픽스 적용, Swagger 경로로 통일.
   - `config.js`의 ADMIN/USER/EUME_CHAT/USER_CHAT를 아래로 교체:
   ```javascript
   export const API_ENDPOINTS = {
     HEALTH_CHECK: `${JAVA_URL}health-check`,
     USER: {
       ME: `${JAVA_URL}api/users/me`,
       LOGOUT: `${JAVA_URL}api/users/logout`,
       WITHDRAW: `${JAVA_URL}api/users/me/withdraw`,
       DEACTIVATE: `${JAVA_URL}api/users/me/deactivate`,
     },
     EUME_CHAT: {
       CREATE: `${JAVA_URL}api/eume-chats`,
       ME: `${JAVA_URL}api/eume-chats/me`,
       CONTENTS: id => `${JAVA_URL}api/eume-chats/${id}/contents`,
     },
     USER_CHAT: {
       LIST: `${JAVA_URL}api/user-chats`,
       CREATE: `${JAVA_URL}api/user-chats`,
       CONTENTS: id => `${JAVA_URL}api/user-chats/${id}/contents`,
     },
     ADMIN: {
       LOGIN: `${JAVA_URL}api/admin/login`,
       LOGOUT: `${JAVA_URL}api/admin/logout`,
       REGISTER: `${JAVA_URL}api/admin/register`,
       ORGS: `${JAVA_URL}api/admin/orgs`,
       USERS: `${JAVA_URL}api/admin/users`,
       USER_DETAIL: id => `${JAVA_URL}api/admin/users/${id}`,
       USER_STATUS: id => `${JAVA_URL}api/admin/users/${id}/status`,
       USER_EMOTIONS: id => `${JAVA_URL}api/admin/users/${id}/emotions`,
       USERS_EXPORT: `${JAVA_URL}api/admin/users/export`,
       REPORTS_SUMMARY: `${JAVA_URL}api/admin/reports/summary`,
       REPORTS_EXPORT: `${JAVA_URL}api/admin/reports/export`,
     },
   };
   ```
2) **인증 방식 일원화**: `axiosInstance`에 `withCredentials: true` 추가, Bearer 토큰 의존 제거(백엔드가 쿠키 기반이라면 Authorization 헤더 삭제 또는 선택적 사용).
3) **관리자 로그인 페이로드 수정**: `admin/pages/Login.jsx`를 `sigunguId + adminLoginId + adminPw`로 전환, `loginType` 제거.
4) **OAuth 흐름 정리**: `user/pages/OAuth2Redirect.jsx`의 `fetch('/api/users/me')`를 `axiosInstance.get(API_ENDPOINTS.USER.ME)`로 교체해 인터셉터/쿠키 적용.
5) **회원가입 플로우 재정의**: 백엔드에 `/api/users/register`가 없으므로 `Onboarding4.jsx`의 REGISTER 호출 제거 → OAuth2 후 `/api/users/me` 기반 프로필 업데이트(예: PUT /api/users/me)로 대체.
6) **테마 매핑 추가**: 프론트 테마 문자열(ocean/sunset/forest 등)과 백엔드 enum(DEFAULT/DARK/LIGHT) 매핑 유틸을 추가하고, 저장/조회 시 변환 적용.

## 3. 보완 작업 (단기)
- **Health Check 노출**: `HEALTH_CHECK: ${JAVA_URL}health-check`를 `API_ENDPOINTS`에 포함하고 필요 시 공용 레이턴시 체크에 활용.
- **UserChat 요청 스키마**: roomTitle, messageType 등 Swagger 스펙 확인 후 요청 인터페이스 반영.
- **Pagination 공통 타입**: 리스트 API 응답에 `currentPage/totalPages/totalElements/hasNext` 등 공통 필드를 사용하도록 타입/헬퍼 정의.
- **응답 인터셉터 선택적 사용**: 로그인/회원가입 등 상태코드 분기가 필요한 API는 원본 응답을 반환하도록 인터셉터 우회 옵션 마련.

## 4. 검증 체크리스트
1) 사용자: 로그인/OAuth2 → `GET /api/users/me` 성공, 프로필 수정/탈퇴/비활성화 동작 확인.
2) 채팅: `GET /api/eume-chats/me` → `POST /api/eume-chats` → 콘텐츠 조회/송신(양방향) 확인.
3) 관리자: 로그인 → 조직 선택 → 사용자 목록/상세/상태 변경 → 감정 모니터 → 보고서 요약/엑셀 다운로드.
4) 공통: 모든 요청이 `/api/...` 경로이며 쿠키 포함 여부 확인, CORS 설정(Origin/Credentials) 유효성 점검.

## 5. 환경 메모
- `.env.example`의 `VITE_API_URL`은 백엔드 기본 URL(끝에 `/`)로 유지. 운영/개발 모두 프론트에서 `/api/` 포함 경로를 책임.
- 개발 OS: Windows 11, UTF-8 + CRLF 유지.

## 6. 변경 이력
| 일시 | 버전 | 작성자 | 내용 |
|------|------|--------|------|
| 2025-11-28 | 2.0 제안 | Codex | 001 문서/코드/Swagger 재검토 후 v2 적용안 작성 |
